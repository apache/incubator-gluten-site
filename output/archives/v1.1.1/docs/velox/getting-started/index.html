<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul:nth-of-type(2) > li > ul > li > a, .site-nav > ul:nth-of-type(2) > li > ul > li > ul > li > a, .site-nav > ul:nth-of-type(2) > li > ul > li > ul > li > ul > li > a, .site-nav > ul:nth-of-type(2) > li > ul > li > ul > li > ul > li > ul > li > a, .site-nav > ul:nth-of-type(2) > li > ul > li > ul > li > ul > li > ul > li > ul > li:not(:nth-child(1)) > a, .site-nav > ul:nth-of-type(2) > li > ul > li > ul > li > ul > li > ul > li > ul > li > ul > li a { background-image: none; } .site-nav > ul:not(:nth-of-type(2)) a, .site-nav li.external a { background-image: none; } .site-nav > ul:nth-of-type(2) > li > ul > li:nth-child(2) > ul > li:nth-child(1) > ul > li:nth-child(1) > ul > li:nth-child(1) > ul > li:nth-child(1) > a { font-weight: 600; text-decoration: none; } .site-nav > ul.nav-category-list > li > button svg, .site-nav > ul:nth-of-type(2) > li > ul > li:nth-child(2) > button svg, .site-nav > ul:nth-of-type(2) > li > ul > li:nth-child(2) > ul > li:nth-child(1) > button svg, .site-nav > ul:nth-of-type(2) > li > ul > li:nth-child(2) > ul > li:nth-child(1) > ul > li:nth-child(1) > button svg, .site-nav > ul:nth-of-type(2) > li > ul > li:nth-child(2) > ul > li:nth-child(1) > ul > li:nth-child(1) > ul > li:nth-child(1) > button svg, .site-nav > ul:nth-of-type(2) > li > ul > li:nth-child(2) > ul > li:nth-child(1) > ul > li:nth-child(1) > ul > li:nth-child(1) > ul > li:nth-child(1) > button svg { transform: rotate(-90deg); } .site-nav > ul.nav-category-list > li.nav-list-item > ul.nav-list, .site-nav > ul:nth-of-type(2) > li > ul > li.nav-list-item:nth-child(2) > ul.nav-list, .site-nav > ul:nth-of-type(2) > li > ul > li.nav-list-item:nth-child(2) > ul.nav-list > li.nav-list-item:nth-child(1) > ul.nav-list, .site-nav > ul:nth-of-type(2) > li > ul > li.nav-list-item:nth-child(2) > ul.nav-list > li.nav-list-item:nth-child(1) > ul.nav-list > li.nav-list-item:nth-child(1) > ul.nav-list, .site-nav > ul:nth-of-type(2) > li > ul > li.nav-list-item:nth-child(2) > ul.nav-list > li.nav-list-item:nth-child(1) > ul.nav-list > li.nav-list-item:nth-child(1) > ul.nav-list > li.nav-list-item:nth-child(1) > ul.nav-list, .site-nav > ul:nth-of-type(2) > li > ul > li.nav-list-item:nth-child(2) > ul.nav-list > li.nav-list-item:nth-child(1) > ul.nav-list > li.nav-list-item:nth-child(1) > ul.nav-list > li.nav-list-item:nth-child(1) > ul.nav-list > li.nav-list-item:nth-child(1) > ul.nav-list { display: block; } </style> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>v1.1.1/Getting-Started with Velox Backend | Apache Gluten incubating</title> <meta name="generator" content="Jekyll v3.9.3" /> <meta property="og:title" content="v1.1.1/Getting-Started with Velox Backend" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Supported Version | Type | Version | |——-|——————————| | Spark | 3.2.2, 3.3.1 | | OS | Ubuntu20.04/22.04, Centos7/8 | | jdk | openjdk8 | | scala | 2.12" /> <meta property="og:description" content="Supported Version | Type | Version | |——-|——————————| | Spark | 3.2.2, 3.3.1 | | OS | Ubuntu20.04/22.04, Centos7/8 | | jdk | openjdk8 | | scala | 2.12" /> <link rel="canonical" href="https://gluten.apache.org/archives/v1.1.1/docs/velox/getting-started/" /> <meta property="og:url" content="https://gluten.apache.org/archives/v1.1.1/docs/velox/getting-started/" /> <meta property="og:site_name" content="Apache Gluten incubating" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2025-06-26T03:28:29+00:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="v1.1.1/Getting-Started with Velox Backend" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-06-26T03:28:29+00:00","datePublished":"2025-06-26T03:28:29+00:00","description":"Supported Version | Type | Version | |——-|——————————| | Spark | 3.2.2, 3.3.1 | | OS | Ubuntu20.04/22.04, Centos7/8 | | jdk | openjdk8 | | scala | 2.12","headline":"v1.1.1/Getting-Started with Velox Backend","mainEntityOfPage":{"@type":"WebPage","@id":"https://gluten.apache.org/archives/v1.1.1/docs/velox/getting-started/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://gluten.apache.org/assets/images/gluten-logo-blue.png"}},"url":"https://gluten.apache.org/archives/v1.1.1/docs/velox/getting-started/"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"> <div class="site-logo" role="img" aria-label="Apache Gluten incubating"></div> </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/downloads/" class="nav-list-link">Downloads</a></li><li class="nav-list-item"><a href="/blog/" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/references/" class="nav-list-link">Gluten References</a></li><li class="nav-list-item"><a href="/poweredby/" class="nav-list-link">Powered by Gluten</a></li><li class="nav-list-item"><a href="/contributing/" class="nav-list-link">Contributing to Gluten</a></li><li class="nav-list-item"><a href="/contact/" class="nav-list-link">Contact Us</a></li><li class="nav-list-item"><a href="/about/" class="nav-list-link">About</a></li></ul> <ul class="nav-list nav-category-list"> <li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="Toggle collection Documentations" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><div class="nav-category">Documentations</div> <ul class="nav-list"><li class="nav-list-item"><a href="/docs/latest.html" class="nav-list-link">Documentation(Latest)</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Archives category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/" class="nav-list-link">Archives</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in v1.1.1 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.1.1/" class="nav-list-link">v1.1.1</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in v1.1.1/Documentation category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.1.1/docs/" class="nav-list-link">v1.1.1/Documentation</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in v1.1.1/Velox Backend category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.1.1/docs/velox/" class="nav-list-link">v1.1.1/Velox Backend</a><ul class="nav-list"><li class="nav-list-item"><a href="/archives/v1.1.1/docs/velox/getting-started/" class="nav-list-link">v1.1.1/Getting-Started with Velox Backend</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/docs/velox/build_parameters/" class="nav-list-link">v1.1.1/Build Parameters for Velox Backend</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/docs/velox/s3/" class="nav-list-link">v1.1.1/Using S3 with Gluten</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/docs/velox/gcs/" class="nav-list-link">v1.1.1/Using GCS with Gluten</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in v1.1.1/ClickHouse Backend category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.1.1/docs/clickhouse/" class="nav-list-link">v1.1.1/ClickHouse Backend</a><ul class="nav-list"><li class="nav-list-item"><a href="/archives/v1.1.1/docs/clickhouse/getting-started/" class="nav-list-link">v1.1.1/Getting Started with ClickHouse Backend</a></li></ul></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in v1.1.1/Developers category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.1.1/developers/" class="nav-list-link">v1.1.1/Developers</a><ul class="nav-list"><li class="nav-list-item"><a href="/archives/v1.1.1/developers/newto/" class="nav-list-link">v1.1.1/New To Gluten</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/howto/" class="nav-list-link">v1.1.1/How To Use Gluten</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/microbenchmark/" class="nav-list-link">v1.1.1/Micro Benchmarks for Velox Backend</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/cpp_code_style/" class="nav-list-link">v1.1.1/CPP Code Style</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/velox_function_development/" class="nav-list-link">v1.1.1/Velox Function Development</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/docker_ubuntu/" class="nav-list-link">v1.1.1/Docker script for Ubuntu 22.04/20.04</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/docker_centos8" class="nav-list-link">v1.1.1/Docker script for CentOS 8</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/docker_centos7/" class="nav-list-link">v1.1.1/Docker script for CentOS 7</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/substrait/" class="nav-list-link">v1.1.1/Substrait Modifications</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/howtorelease/" class="nav-list-link">v1.1.1/How To Release</a></li></ul></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in v1.2.1 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.2.1/" class="nav-list-link">v1.2.1</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Documentations(v1.2.1) category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.2.1/docs/" class="nav-list-link">Documentations(v1.2.1)</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Getting-Started(v1.2.1) category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.2.1/docs/getting-started/" class="nav-list-link">Getting-Started(v1.2.1)</a><ul class="nav-list"><li class="nav-list-item"><a href="/archives/v1.2.1/docs/getting-started/velox-backend/" class="nav-list-link">Getting Start with Velox Backend(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/getting-started/clickhouse-backend/" class="nav-list-link">Getting start with ClickHouse Backend(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/getting-started/build-guide/" class="nav-list-link">Build Parameters for Velox Backend(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/getting-started/s3/" class="nav-list-link">Using S3 with Gluten(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/getting-started/gcs/" class="nav-list-link">Using GCS with Gluten(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/getting-started/abfs/" class="nav-list-link">Using ABFS with Gluten(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/getting-started/localcache/" class="nav-list-link">Velox Local Caching(v1.2.1)</a></li></ul></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/configuration/" class="nav-list-link">Configuration(v1.2.1)</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Developers(v1.2.1) category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.2.1/docs/developers/" class="nav-list-link">Developers(v1.2.1)</a><ul class="nav-list"><li class="nav-list-item"><a href="/archives/v1.2.1/docs/developers/how-to-use/" class="nav-list-link">How To Use Gluten(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/developers/new-to/" class="nav-list-link">New To Gluten(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/developers/microbenchmarks/" class="nav-list-link">Micro Benchmarks for Velox Backend(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/developers/cpp-code-style/" class="nav-list-link">CPP Code Style(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/developers/velox-function-dev/" class="nav-list-link">Velox Function Development(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/developers/docker-ubuntu/" class="nav-list-link">Docker script for Ubuntu 22.04/20.04(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/developers/docker-centos7/" class="nav-list-link">Docker script for CentOS 7(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/developers/docker-centos8/" class="nav-list-link">Docker script for CentOS 8(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/developers/substrait/" class="nav-list-link">Substrait Modifications(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/developers/how-to-release/" class="nav-list-link">How To Release(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/developers/how-to-security-scan/" class="nav-list-link">How To Scan Security issues(v1.2.1)</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Velox Backend(v1.2.1) category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.2.1/docs/velox-backend/" class="nav-list-link">Velox Backend(v1.2.1)</a><ul class="nav-list"><li class="nav-list-item"><a href="/archives/v1.2.1/docs/velox-backend/support/" class="nav-list-link">Supported Operators & Functions(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/velox-backend/limitations/" class="nav-list-link">Limitations(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/velox-backend/troubleshooting/" class="nav-list-link">Troubleshooting(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/velox-backend/udf/" class="nav-list-link">Velox UDF(v1.2.1)</a></li></ul></li></ul></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in v1.3.0 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.3.0/" class="nav-list-link">v1.3.0</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Getting-Started category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.3.0/getting-started" class="nav-list-link">Getting-Started</a><ul class="nav-list"><li class="nav-list-item"><a href="/archives/v1.3.0/getting-started/velox-backend/" class="nav-list-link">Getting Start with Velox Backend</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/getting-started/clickhouse-backend/" class="nav-list-link">Getting start with ClickHouse Backend</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/getting-started/build-guide/" class="nav-list-link">Build Parameters for Velox Backend</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/getting-started/s3/" class="nav-list-link">Using S3 with Gluten</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/getting-started/gcs/" class="nav-list-link">Using GCS with Gluten</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/getting-started/abfs/" class="nav-list-link">Using ABFS with Gluten</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/getting-started/localcache/" class="nav-list-link">Velox Local Caching</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Velox Backend category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.3.0/velox-backend" class="nav-list-link">Velox Backend</a><ul class="nav-list"><li class="nav-list-item"><a href="/archives/v1.3.0/velox-backend/support/" class="nav-list-link">Supported Operators & Functions</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/velox-backend/limitations/" class="nav-list-link">Limitations</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/velox-backend/troubleshooting/" class="nav-list-link">Troubleshooting</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/velox-backend/udf/" class="nav-list-link">Velox UDF</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Developers category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.3.0/developers" class="nav-list-link">Developers</a><ul class="nav-list"><li class="nav-list-item"><a href="/archives/v1.3.0/developers/how-to-use/" class="nav-list-link">How To Use Gluten</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/developers/new-to/" class="nav-list-link">New To Gluten</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/developers/microbenchmarks/" class="nav-list-link">Micro Benchmarks for Velox Backend</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/developers/velox-function-dev/" class="nav-list-link">Velox Function Development</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/developers/docker-ubuntu/" class="nav-list-link">Docker script for Ubuntu 22.04/20.04</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/developers/docker-centos7/" class="nav-list-link">Docker script for CentOS 7</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/developers/docker-centos8/" class="nav-list-link">Docker script for CentOS 8</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/developers/substrait/" class="nav-list-link">Substrait Modifications</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/developers/how-to-security-scan/" class="nav-list-link">How To Scan Security issues</a></li></ul></li><li class="nav-list-item"><a href="/archives/v1.3.0/configuration" class="nav-list-link">Configuration</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/developers/cpp-code-style/" class="nav-list-link">CPP Code Style</a></li></ul></li></ul></li></ul> </li> </ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Apache Gluten incubating" aria-label="Search Apache Gluten incubating" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <style> /* Style The Dropdown Button */ .dropbtn { background-color: #0000ff80; color: white; padding: 22px; width: 100%; font-size: 14px; border: none; cursor: pointer; } /* The container <div> - needed to position the dropdown content */ .dropdown { position: relative; display: inline-block; } /* Dropdown Content (Hidden by Default) */ .dropdown-content { display: none; position: absolute; background-color: #f9f9f9; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; } /* Links inside the dropdown */ .dropdown-content a { color: black; padding: 12px 14px; text-decoration: none; display: block; } /* Change color of dropdown links on hover */ .dropdown-content a:hover {background-color: #f1f1f1} /* Show the dropdown menu on hover */ .dropdown:hover .dropdown-content { display: block; } /* Change the background color of the dropdown button when the dropdown content is shown */ .dropdown:hover .dropbtn { background-color: #0000ff; } </style> <!-- Collect the nav links, forms, and other content for toggling --> <div class="dropdown" id="apache-navbar" style="float:left;"> <button class="dropbtn">ASF</button> <div class="dropdown-content"> <a class="dropdown-item" href="https://www.apache.org/">Foundation</a> <a class="dropdown-item" href="https://www.apache.org/events/current-event.html">Event</a> <a class="dropdown-item" href="https://www.apache.org/licenses/">License</a> <a class="dropdown-item" href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a> <a class="dropdown-item" href="https://www.apache.org/security/">Security</a> <a class="dropdown-item" href="https://privacy.apache.org/policies/privacy-policy-public.html">Privacy</a> <a class="dropdown-item" href="https://www.apache.org/foundation/thanks.html">Thanks</a> </div> </div><!-- /.navbar-collapse --> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//github.com/apache/incubator-gluten" class="site-button" target="_blank" rel="noopener noreferrer" > Apache Gluten Github </a> </li> </ul> </nav> </div> <div class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/archives/">Archives</a></li> <li class="breadcrumb-nav-list-item"><a href="/archives/v1.1.1/">v1.1.1</a></li> <li class="breadcrumb-nav-list-item"><a href="/archives/v1.1.1/docs/">v1.1.1/Documentation</a></li> <li class="breadcrumb-nav-list-item"><a href="/archives/v1.1.1/docs/velox/">v1.1.1/Velox Backend</a></li> <li class="breadcrumb-nav-list-item"><span>v1.1.1/Getting-Started with Velox Backend</span></li> </ol> </nav> <div id="main-content" class="main-content"> <main> <h1 id="supported-version"> <a href="#supported-version" class="anchor-heading" aria-labelledby="supported-version"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Supported Version </h1> <p>| Type | Version | |——-|——————————| | Spark | 3.2.2, 3.3.1 | | OS | Ubuntu20.04/22.04, Centos7/8 | | jdk | openjdk8 | | scala | 2.12</p> <p>Spark3.4.0 support is still WIP. TPCH/DS can pass, UT is not yet passed.</p> <p>There are pending PRs for jdk11 support.</p> <p>Currently, the mvn script can automatically fetch and build all dependency libraries incluing Velox. Our nightly build still use Velox under oap-project.</p> <h1 id="prerequisite"> <a href="#prerequisite" class="anchor-heading" aria-labelledby="prerequisite"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Prerequisite </h1> <p>Currently, Gluten+Velox backend is only tested on <strong>Ubuntu20.04/Ubuntu22.04/Centos8</strong>. Other kinds of OS support are still in progress. The long term goal is to support several common OS and conda env deployment.</p> <p>Gluten builds with Spark3.2.x and Spark3.3.x now but only fully tested in CI with 3.2.2 and 3.3.1. We will add/update supported/tested versions according to the upstream changes.</p> <p>we need to set up the <code class="language-plaintext highlighter-rouge">JAVA_HOME</code> env. Currently, <strong>java 8</strong> is required and the support for java 11/17 is not ready.</p> <p><strong>For x86_64</strong></p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">## make sure jdk8 is used</span>
<span class="nb">export </span><span class="nv">JAVA_HOME</span><span class="o">=</span>/usr/lib/jvm/java-8-openjdk-amd64
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$JAVA_HOME</span>/bin:<span class="nv">$PATH</span>
</code></pre></div></div> <p><strong>For aarch64</strong></p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">## make sure jdk8 is used</span>
<span class="nb">export </span><span class="nv">JAVA_HOME</span><span class="o">=</span>/usr/lib/jvm/java-8-openjdk-arm64
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$JAVA_HOME</span>/bin:<span class="nv">$PATH</span>
</code></pre></div></div> <p><strong>Get gluten</strong></p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">## config maven, like proxy in ~/.m2/settings.xml</span>

<span class="c">## fetch gluten code</span>
git clone https://github.com/oap-project/gluten.git
</code></pre></div></div> <h1 id="build-gluten-with-velox-backend"> <a href="#build-gluten-with-velox-backend" class="anchor-heading" aria-labelledby="build-gluten-with-velox-backend"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Build Gluten with Velox Backend </h1> <p>It’s recommended to use buildbundle-veloxbe.sh to build gluten in one script. <a href="./build-guide.md">Gluten build guide</a> listed the parameters and their default value of build command for your reference.</p> <p><strong>For x86_64 build</strong></p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /path/to/gluten

<span class="c">## The script builds two jars for spark 3.2.2 and 3.3.1.</span>
./dev/buildbundle-veloxbe.sh

<span class="c">## After a complete build, if you need to re-build the project and only some gluten code is changed,</span>
<span class="c">## you can use the following command to skip building velox and protobuf.</span>
<span class="c"># ./dev/buildbundle-veloxbe.sh --enable_ep_cache=ON --build_protobuf=OFF</span>
<span class="c">## If you have the same error with issue-3283, you need to add the parameter `--compile_arrow_java=ON`</span>
</code></pre></div></div> <p><strong>For aarch64 build:</strong></p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">CPU_TARGET</span><span class="o">=</span><span class="s2">"aarch64"</span>

<span class="nb">cd</span> /path/to/gluten

./dev/builddeps-veloxbe.sh
</code></pre></div></div> <p><strong>Build Velox separately</strong></p> <p>Scripts under <code class="language-plaintext highlighter-rouge">/path/to/gluten/ep/build-velox/src</code> provide <code class="language-plaintext highlighter-rouge">get_velox.sh</code> and <code class="language-plaintext highlighter-rouge">build_velox.sh</code> to build Velox separately, you could use these scripts with custom repo/branch/location.</p> <p>Velox provides arrow/parquet lib. Gluten cpp module need a required VELOX_HOME parsed by –velox_home, if you specify custom ep location, make sure these variables be passed correctly.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">## fetch Velox and compile</span>
<span class="nb">cd</span> /path/to/gluten/ep/build-velox/src/
<span class="c">## you could use custom ep location by --velox_home=custom_path, make sure specify --velox_home in build_velox.sh too.</span>
./get_velox.sh
<span class="c">## make sure specify --velox_home if you have specified it in get_velox.sh.</span>
./build_velox.sh

<span class="c">## compile Gluten cpp module</span>
<span class="nb">cd</span> /path/to/gluten/cpp
<span class="c">## if you use custom velox_home, make sure specified here by --velox_home </span>
./compile.sh <span class="nt">--build_velox_backend</span><span class="o">=</span>ON

<span class="c">## compile Gluten java module and create package jar</span>
<span class="nb">cd</span> /path/to/gluten
<span class="c"># For spark3.2.x</span>
mvn clean package <span class="nt">-Pbackends-velox</span> <span class="nt">-Prss</span> <span class="nt">-Pspark-3</span>.2 <span class="nt">-DskipTests</span>
<span class="c"># For spark3.3.x</span>
mvn clean package <span class="nt">-Pbackends-velox</span> <span class="nt">-Prss</span> <span class="nt">-Pspark-3</span>.3 <span class="nt">-DskipTests</span>
</code></pre></div></div> <p>notes：The compilation of <code class="language-plaintext highlighter-rouge">Velox</code> using the script of <code class="language-plaintext highlighter-rouge">build_velox.sh</code> may fail caused by <code class="language-plaintext highlighter-rouge">oom</code>, you can prevent this failure by using the user command of <code class="language-plaintext highlighter-rouge">export NUM_THREADS=4</code> before executing the above scripts.</p> <p>Once building successfully, the Jar file will be generated in the directory: package/target/&lt;gluten-jar&gt; for Spark 3.2.x/Spark 3.3.x.</p> <h2 id="dependency-library-deployment"> <a href="#dependency-library-deployment" class="anchor-heading" aria-labelledby="dependency-library-deployment"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Dependency library deployment </h2> <p>With config <code class="language-plaintext highlighter-rouge">enable_vcpkg=ON</code>, the dependency libraries will be built and statically linked into libvelox.so and libgluten.so, which is packed into the gluten-jar. In this way, only the gluten-jar is needed to add to <code class="language-plaintext highlighter-rouge">spark.&lt;driver|executor&gt;.extraClassPath</code> and spark will deploy the jar to each worker node. It’s better to build the static version using a clean docker image without any extra libraries installed. On host with some libraries like jemalloc installed, the script may crash with odd message. You may need to uninstall those libraries to get a clean host.</p> <p>With config <code class="language-plaintext highlighter-rouge">enable_vcpkg=OFF</code>, the dependency libraries won’t be statically linked, instead the script will install the libraries to system then pack the dependency libraries into another jar named gluten-package-${Maven-artifact-version}.jar. Then you need to add the jar to extraClassPath then set <code class="language-plaintext highlighter-rouge">spark.gluten.loadLibFromJar=true</code>. Or you already manually deployed the dependency libraries on each worker node. You may find the libraries list from the gluten-package jar.</p> <h2 id="hdfs-support"> <a href="#hdfs-support" class="anchor-heading" aria-labelledby="hdfs-support"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> HDFS support </h2> <p>Hadoop hdfs support is ready via the <a href="https://github.com/apache/hawq/tree/master/depends/libhdfs3">libhdfs3</a> library. The libhdfs3 provides native API for Hadoop I/O without the drawbacks of JNI. It also provides advanced authentication like Kerberos based. Please note this library has several dependencies which may require extra installations on Driver and Worker node.</p> <h3 id="build-with-hdfs-support"> <a href="#build-with-hdfs-support" class="anchor-heading" aria-labelledby="build-with-hdfs-support"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Build with HDFS support </h3> <p>To build Gluten with HDFS support, below command is suggested:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /path/to/gluten
./dev/buildbundle-veloxbe.sh <span class="nt">--enable_hdfs</span><span class="o">=</span>ON
</code></pre></div></div> <h3 id="configuration-about-hdfs-support"> <a href="#configuration-about-hdfs-support" class="anchor-heading" aria-labelledby="configuration-about-hdfs-support"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Configuration about HDFS support </h3> <p>HDFS uris (hdfs://host:port) will be extracted from a valid hdfs file path to initialize hdfs client, you do not need to specify it explicitly.</p> <p>libhdfs3 need a configuration file and <a href="https://github.com/apache/hawq/blob/e9d43144f7e947e071bba48871af9da354d177d0/src/backend/utils/misc/etc/hdfs-client.xml">example here</a>, this file is a bit different from hdfs-site.xml and core-site.xml. Download that example config file to local and do some needed modifications to support HA or else, then set env variable like below to use it, or upload it to HDFS to use, more details <a href="https://github.com/apache/hawq/blob/e9d43144f7e947e071bba48871af9da354d177d0/depends/libhdfs3/src/client/Hdfs.cpp#L171-L189">here</a>.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Spark local mode
export LIBHDFS3_CONF="/path/to/hdfs-client.xml"

// Spark Yarn cluster mode
--conf spark.executorEnv.LIBHDFS3_CONF="/path/to/hdfs-client.xml"

// Spark Yarn cluster mode and upload hdfs config file
cp /path/to/hdfs-client.xml hdfs-client.xml
--files hdfs-client.xml
</code></pre></div></div> <p>One typical deployment on Spark/HDFS cluster is to enable <a href="https://hadoop.apache.org/docs/stable/hadoop-project-dist/hadoop-hdfs/ShortCircuitLocalReads.html">short-circuit reading</a>. Short-circuit reads provide a substantial performance boost to many applications.</p> <p>By default libhdfs3 does not set the default hdfs domain socket path to support HDFS short-circuit read. If this feature is required in HDFS setup, users may need to setup the domain socket path correctly by patching the libhdfs3 source code or by setting the correct config environment. In Gluten the short-circuit domain socket path is set to “/var/lib/hadoop-hdfs/dn_socket” in <a href="https://github.com/oap-project/gluten/blob/main/ep/build-velox/src/build_velox.sh">build_velox.sh</a> So we need to make sure the folder existed and user has write access as below script.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo mkdir -p /var/lib/hadoop-hdfs/
sudo chown &lt;sparkuser&gt;:&lt;sparkuser&gt; /var/lib/hadoop-hdfs/
</code></pre></div></div> <p>You also need to add configuration to the “hdfs-site.xml” as below:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;property&gt;
   &lt;name&gt;dfs.client.read.shortcircuit&lt;/name&gt;
   &lt;value&gt;true&lt;/value&gt;
&lt;/property&gt;
&lt;property&gt;
   &lt;name&gt;dfs.domain.socket.path&lt;/name&gt;
   &lt;value&gt;/var/lib/hadoop-hdfs/dn_socket&lt;/value&gt;
&lt;/property&gt;
</code></pre></div></div> <h3 id="kerberos-support"> <a href="#kerberos-support" class="anchor-heading" aria-labelledby="kerberos-support"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Kerberos support </h3> <p>Here are two steps to enable kerberos.</p> <ul> <li>Make sure the hdfs-client.xml contains</li> </ul> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;property&gt;</span>
    <span class="nt">&lt;name&gt;</span>hadoop.security.authentication<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;value&gt;</span>kerberos<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/property&gt;</span>
</code></pre></div></div> <ul> <li>Specify the environment variable <a href="https://github.com/apache/hawq/blob/e9d43144f7e947e071bba48871af9da354d177d0/depends/libhdfs3/src/client/FileSystem.cpp#L56">KRB5CCNAME</a> and upload the kerberos ticket cache file</li> </ul> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--conf spark.executorEnv.KRB5CCNAME=krb5cc_0000  --files /tmp/krb5cc_0000
</code></pre></div></div> <p>The ticket cache file can be found by <code class="language-plaintext highlighter-rouge">klist</code>.</p> <h2 id="aws-s3-support"> <a href="#aws-s3-support" class="anchor-heading" aria-labelledby="aws-s3-support"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> AWS S3 support </h2> <p>Velox supports S3 with the open source <a href="https://github.com/aws/aws-sdk-cpp">AWS C++ SDK</a> and Gluten uses Velox S3 connector to connect with S3. A new build option for S3(enable_s3) is added. Below command is used to enable this feature</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /path/to/gluten
./dev/buildbundle-veloxbe.sh --enable_s3=ON
</code></pre></div></div> <p>Currently there are several ways to asscess S3 in Spark. Please refer <a href="VeloxS3.md">Velox S3</a> part for more detailed configurations</p> <h2 id="celeborn-support"> <a href="#celeborn-support" class="anchor-heading" aria-labelledby="celeborn-support"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Celeborn support </h2> <p>Gluten with velox backend supports <a href="https://github.com/apache/incubator-celeborn">Celeborn</a> as remote shuffle service. Below introduction is used to enable this feature</p> <p>First refer to this URL(https://github.com/apache/incubator-celeborn) to setup a celeborn cluster.</p> <p>When compiling the Gluten Java module, it’s required to enable <code class="language-plaintext highlighter-rouge">rss</code> profile, as follows:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvn clean package -Pbackends-velox -Pspark-3.3 -Prss -DskipTests
</code></pre></div></div> <p>Then add the Gluten and Spark Celeborn Client packages to your Spark application’s classpath(usually add them into <code class="language-plaintext highlighter-rouge">$SPARK_HOME/jars</code>).</p> <ul> <li>Celeborn: celeborn-client-spark-3-shaded_2.12-0.3.0-incubating.jar</li> <li>Gluten: gluten-velox-bundle-spark3.x_2.12-xx_xx_xx-SNAPSHOT.jar, gluten-thirdparty-lib-xx-xx.jar</li> </ul> <p>Currently to use Gluten following configurations are required in <code class="language-plaintext highlighter-rouge">spark-defaults.conf</code></p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spark.shuffle.manager org.apache.spark.shuffle.gluten.celeborn.CelebornShuffleManager

# celeborn master
spark.celeborn.master.endpoints clb-master:9097

spark.shuffle.service.enabled false

# options: hash, sort
# Hash shuffle writer use (partition count) * (celeborn.push.buffer.max.size) * (spark.executor.cores) memory.
# Sort shuffle writer uses less memory than hash shuffle writer, if your shuffle partition count is large, try to use sort hash writer.  
spark.celeborn.client.spark.shuffle.writer hash

# We recommend setting spark.celeborn.client.push.replicate.enabled to true to enable server-side data replication
# If you have only one worker, this setting must be false 
# If your Celeborn is using HDFS, it's recommended to set this setting to false
spark.celeborn.client.push.replicate.enabled true

# Support for Spark AQE only tested under Spark 3
# we recommend setting localShuffleReader to false to get better performance of Celeborn
spark.sql.adaptive.localShuffleReader.enabled false

# If Celeborn is using HDFS
spark.celeborn.storage.hdfs.dir hdfs://&lt;namenode&gt;/celeborn

# If you want to use dynamic resource allocation,
# please refer to this URL (https://github.com/apache/incubator-celeborn/tree/main/assets/spark-patch) to apply the patch into your own Spark.
spark.dynamicAllocation.enabled false
</code></pre></div></div> <h2 id="deltalake-support"> <a href="#deltalake-support" class="anchor-heading" aria-labelledby="deltalake-support"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> DeltaLake Support </h2> <p>Gluten with velox backend supports <a href="https://delta.io/">DeltaLake</a> table.</p> <h3 id="how-to-use"> <a href="#how-to-use" class="anchor-heading" aria-labelledby="how-to-use"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> How to use </h3> <p>First of all, compile gluten-delta module by a <code class="language-plaintext highlighter-rouge">delta</code> profile, as follows:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvn clean package -Pbackends-velox -Pspark-3.3 -Pdelta -DskipTests
</code></pre></div></div> <p>Then, put the additional gluten-delta jar to the class path (usually it’s <code class="language-plaintext highlighter-rouge">$SPARK_HOME/jars</code>). The gluten-delta jar is in <code class="language-plaintext highlighter-rouge">gluten-delta/target</code> directory.</p> <p>After the two steps, you can query delta table by gluten/velox without scan’s fallback.</p> <p>Gluten with velox backends also support the column mapping of delta tables. About column mapping, see more <a href="https://docs.delta.io/latest/delta-column-mapping.html">here</a>.</p> <h2 id="iceberg-support"> <a href="#iceberg-support" class="anchor-heading" aria-labelledby="iceberg-support"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Iceberg Support </h2> <p>Gluten with velox backend supports <a href="https://iceberg.apache.org/">Iceberg</a> table. Currently, only reading COW (Copy-On-Write) tables is supported.</p> <h3 id="how-to-use-1"> <a href="#how-to-use-1" class="anchor-heading" aria-labelledby="how-to-use-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> How to use </h3> <p>First of all, compile gluten-iceberg module by a <code class="language-plaintext highlighter-rouge">iceberg</code> profile, as follows:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvn clean package -Pbackends-velox -Pspark-3.3 -Piceberg -DskipTests
</code></pre></div></div> <p>Then, put the additional gluten-iceberg jar to the class path (usually it’s <code class="language-plaintext highlighter-rouge">$SPARK_HOME/jars</code>). The gluten-iceberg jar is in <code class="language-plaintext highlighter-rouge">gluten-iceberg/target</code> directory.</p> <p>After the two steps, you can query iceberg table by gluten/velox without scan’s fallback.</p> <h1 id="coverage"> <a href="#coverage" class="anchor-heading" aria-labelledby="coverage"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Coverage </h1> <p>Spark3.3 has 387 functions in total. ~240 are commonly used. Velox’s functions have two category, Presto and Spark. Presto has 124 functions implemented. Spark has 62 functions. Spark functions are verified to have the same result as Vanilla Spark. Some Presto functions have the same result as Vanilla Spark but some others have different. Gluten prefer to use Spark functions firstly. If it’s not in Spark’s list but implemented in Presto, we currently offload to Presto one until we noted some result mismatch, then we need to reimplement the function in Spark category. Gluten currently offloads 94 functions and 14 operators, more details refer to <a href="../velox-backend-support-progress.md">Velox Backend’s Supported Operators &amp; Functions</a>.</p> <blockquote> <p>Velox doesn’t support <a href="https://spark.apache.org/docs/latest/sql-ref-ansi-compliance.html">ANSI mode</a>), so as Gluten. Once ANSI mode is enabled in Spark config, Gluten will fallback to Vanilla Spark.</p> </blockquote> <p>To identify what can be offloaded in a query and detailed fallback reasons, user can follow below steps to retrieve corresponding logs.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1) Enable Gluten by proper [configuration](https://github.com/oap-project/gluten/blob/main/docs/Configuration.md).

2) Disable Spark AQE to trigger plan validation in Gluten
spark.sql.adaptive.enabled = false

3) Check physical plan 
sparkSession.sql("your_sql").explain()
</code></pre></div></div> <p>With above steps, you will get a physical plan output like:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>== Physical Plan ==
-Execute InsertIntoHiveTable (7)
  +- Coalesce (6)
    +- VeloxColumnarToRowExec (5)
      +- ^ ProjectExecTransformer (3)
        +- GlutenRowToArrowColumnar (2)
          +- Scan hive default.extracted_db_pins (1)

</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">GlutenRowToArrowColumnar</code>/<code class="language-plaintext highlighter-rouge">VeloxColumnarToRowExec</code> indicates there is a fallback operator before or after it. And you may find fallback reason like below in logs.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>native validation failed due to: in ProjectRel, Scalar function name not registered: get_struct_field, called with arguments: (ROW&lt;col_0:INTEGER,col_1:BIGINT,col_2:BIGINT&gt;, INTEGER).
</code></pre></div></div> <p>In the above, the symbol <code class="language-plaintext highlighter-rouge">^</code> indicates a plan is offloaded to Velox in a stage. In Spark DAG, all such pipelined plans (consecutive plans marked with <code class="language-plaintext highlighter-rouge">^</code>) are plotted inside an umbrella node named <code class="language-plaintext highlighter-rouge">WholeStageCodegenTransformer</code> (It’s not codegen node. The naming is just for making it well plotted like Spark Whole Stage Codegen).</p> <h1 id="spill-experimental"> <a href="#spill-experimental" class="anchor-heading" aria-labelledby="spill-experimental"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Spill (Experimental) </h1> <p>Velox backend supports spilling-to-disk.</p> <p>Using the following configuration options to customize spilling:</p> <div class="table-wrapper"><table> <thead> <tr> <th>Name</th> <th>Default Value</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td>spark.gluten.sql.columnar.backend.velox.spillStrategy</td> <td>auto</td> <td>none: Disable spill on Velox backend; auto: Let Spark memory manager manage Velox’s spilling</td> </tr> <tr> <td>spark.gluten.sql.columnar.backend.velox.spillFileSystem</td> <td>local</td> <td>The filesystem used to store spill data. local: The local file system. heap-over-local: Write files to JVM heap if having extra heap space. Otherwise write to local file system.</td> </tr> <tr> <td>spark.gluten.sql.columnar.backend.velox.aggregationSpillEnabled</td> <td>true</td> <td>Whether spill is enabled on aggregations</td> </tr> <tr> <td>spark.gluten.sql.columnar.backend.velox.joinSpillEnabled</td> <td>true</td> <td>Whether spill is enabled on joins</td> </tr> <tr> <td>spark.gluten.sql.columnar.backend.velox.orderBySpillEnabled</td> <td>true</td> <td>Whether spill is enabled on sorts</td> </tr> <tr> <td>spark.gluten.sql.columnar.backend.velox.aggregationSpillMemoryThreshold</td> <td>0</td> <td>Memory limit before spilling to disk for aggregations, per Spark task. Unit: byte</td> </tr> <tr> <td>spark.gluten.sql.columnar.backend.velox.joinSpillMemoryThreshold</td> <td>0</td> <td>Memory limit before spilling to disk for joins, per Spark task. Unit: byte</td> </tr> <tr> <td>spark.gluten.sql.columnar.backend.velox.orderBySpillMemoryThreshold</td> <td>0</td> <td>Memory limit before spilling to disk for sorts, per Spark task. Unit: byte</td> </tr> <tr> <td>spark.gluten.sql.columnar.backend.velox.maxSpillLevel</td> <td>4</td> <td>The max allowed spilling level with zero being the initial spilling level</td> </tr> <tr> <td>spark.gluten.sql.columnar.backend.velox.maxSpillFileSize</td> <td>20MB</td> <td>The max allowed spill file size. If it is zero, then there is no limit</td> </tr> <tr> <td>spark.gluten.sql.columnar.backend.velox.minSpillRunSize</td> <td>268435456</td> <td>The min spill run size limit used to select partitions for spilling</td> </tr> <tr> <td>spark.gluten.sql.columnar.backend.velox.spillStartPartitionBit</td> <td>29</td> <td>The start partition bit which is used with ‘spillPartitionBits’ together to calculate the spilling partition number</td> </tr> <tr> <td>spark.gluten.sql.columnar.backend.velox.spillPartitionBits</td> <td>2</td> <td>The number of bits used to calculate the spilling partition number. The number of spilling partitions will be power of two</td> </tr> <tr> <td>spark.gluten.sql.columnar.backend.velox.spillableReservationGrowthPct</td> <td>25</td> <td>The spillable memory reservation growth percentage of the previous memory reservation size</td> </tr> </tbody> </table></div> <h1 id="velox-user-defined-functions-udf"> <a href="#velox-user-defined-functions-udf" class="anchor-heading" aria-labelledby="velox-user-defined-functions-udf"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Velox User-Defined Functions (UDF) </h1> <h2 id="introduction"> <a href="#introduction" class="anchor-heading" aria-labelledby="introduction"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Introduction </h2> <p>Velox backend supports User-Defined Functions (UDF). Users can create their own functions using the UDF interface provided in Velox backend and build libraries for these functions. At runtime, the UDF are registered at the start of applications. Once registered, Gluten will be able to parse and offload these UDF into Velox during execution.</p> <h2 id="creating-a-udf-library"> <a href="#creating-a-udf-library" class="anchor-heading" aria-labelledby="creating-a-udf-library"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Creating a UDF library </h2> <p>The following steps demonstrate how to set up a UDF library project:</p> <ul> <li> <p><strong>Include the UDF Interface Header:</strong> First, include the UDF interface header file <a href="../../cpp/velox/udf/Udf.h">Udf.h</a> in the project file. The header file defines the <code class="language-plaintext highlighter-rouge">UdfEntry</code> struct, along with the macros for declaring the necessary functions to integrate the UDF into Gluten and Velox.</p> </li> <li> <p><strong>Implement the UDF:</strong> Implement UDF. These functions should be able to register to Velox.</p> </li> <li> <p><strong>Implement the Interface Functions:</strong> Implement the following interface functions that integrate UDF into Project Gluten:</p> <ul> <li> <p><code class="language-plaintext highlighter-rouge">getNumUdf()</code>: This function should return the number of UDF in the library. This is used to allocating udfEntries array as the argument for the next function <code class="language-plaintext highlighter-rouge">getUdfEntries</code>.</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">getUdfEntries(gluten::UdfEntry* udfEntries)</code>: This function should populate the provided udfEntries array with the details of the UDF, including function names and return types.</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">registerUdf()</code>: This function is called to register the UDF to Velox function registry. This is where users should register functions by calling <code class="language-plaintext highlighter-rouge">facebook::velox::exec::registerVecotorFunction</code> or other Velox APIs.</p> </li> <li> <p>The interface functions are mapping to marcos in <a href="../../cpp/velox/udf/Udf.h">Udf.h</a>. Here’s an example of how to implement these functions:</p> </li> </ul> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Filename MyUDF.cpp</span>

<span class="cp">#include &lt;velox/expression/VectorFunction.h&gt;
#include &lt;velox/udf/Udf.h&gt;
</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">kNumMyUdf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">gluten</span><span class="o">::</span><span class="n">UdfEntry</span> <span class="n">myUdf</span><span class="p">[</span><span class="n">kNumMyUdf</span><span class="p">]</span> <span class="o">=</span> <span class="n">myudf1</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyUdf</span> <span class="o">:</span> <span class="k">public</span> <span class="n">facebook</span><span class="o">::</span><span class="n">velox</span><span class="o">::</span><span class="n">exec</span><span class="o">::</span><span class="n">VectorFunction</span> <span class="p">{</span>
  <span class="p">...</span> <span class="c1">// Omit concrete implementation</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">exec</span><span class="o">::</span><span class="n">FunctionSignature</span><span class="o">&gt;&gt;</span>
<span class="n">myUdfSignatures</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span><span class="n">facebook</span><span class="o">::</span><span class="n">velox</span><span class="o">::</span><span class="n">exec</span><span class="o">::</span><span class="n">FunctionSignatureBuilder</span><span class="p">()</span>
              <span class="p">.</span><span class="n">returnType</span><span class="p">(</span><span class="n">myUdf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dataType</span><span class="p">)</span>
              <span class="p">.</span><span class="n">argumentType</span><span class="p">(</span><span class="s">"integer"</span><span class="p">)</span>
              <span class="p">.</span><span class="n">build</span><span class="p">()};</span>
<span class="p">}</span>

<span class="n">DEFINE_GET_NUM_UDF</span> <span class="p">{</span> <span class="k">return</span> <span class="n">kNumMyUdf</span><span class="p">;</span> <span class="p">}</span>

<span class="n">DEFINE_GET_UDF_ENTRIES</span> <span class="p">{</span> <span class="n">udfEntries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">myUdf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="p">}</span>

<span class="n">DEFINE_REGISTER_UDF</span> <span class="p">{</span>
  <span class="n">facebook</span><span class="o">::</span><span class="n">velox</span><span class="o">::</span><span class="n">exec</span><span class="o">::</span><span class="n">registerVectorFunction</span><span class="p">(</span>
      <span class="n">myUdf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">myUdfSignatures</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">MyUdf</span><span class="o">&gt;</span><span class="p">());</span>
<span class="p">}</span>

</code></pre></div> </div> </li> </ul> <h2 id="building-the-udf-library"> <a href="#building-the-udf-library" class="anchor-heading" aria-labelledby="building-the-udf-library"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Building the UDF library </h2> <p>To build the UDF library, users need to compile the C++ code and link to <code class="language-plaintext highlighter-rouge">libvelox.so</code>. It’s recommended to create a CMakeLists.txt for the project. Here’s an example:</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">project</span><span class="p">(</span><span class="n">myudf</span><span class="p">)</span>

<span class="n">set</span><span class="p">(</span><span class="n">CMAKE_CXX_STANDARD</span> <span class="mi">17</span><span class="p">)</span>
<span class="n">set</span><span class="p">(</span><span class="n">CMAKE_CXX_STANDARD_REQUIRED</span> <span class="n">ON</span><span class="p">)</span>

<span class="n">set</span><span class="p">(</span><span class="n">GLUTEN_HOME</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">gluten</span><span class="p">)</span>

<span class="n">add_library</span><span class="p">(</span><span class="n">myudf</span> <span class="n">SHARED</span> <span class="s">"MyUDF.cpp"</span><span class="p">)</span>

<span class="n">find_library</span><span class="p">(</span><span class="n">VELOX_LIBRARY</span> <span class="n">REQUIRED</span> <span class="n">NAMES</span> <span class="n">velox</span> <span class="n">HINTS</span> <span class="err">$</span><span class="p">{</span><span class="n">GLUTEN_HOME</span><span class="p">}</span><span class="o">/</span><span class="n">cpp</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">releases</span> <span class="n">NO_DEFAULT_PATH</span><span class="p">)</span>

<span class="n">target_include_directories</span><span class="p">(</span><span class="n">myudf</span> <span class="n">PRIVATE</span> <span class="err">$</span><span class="p">{</span><span class="n">GLUTEN_HOME</span><span class="p">}</span><span class="o">/</span><span class="n">cpp</span> <span class="err">$</span><span class="p">{</span><span class="n">GLUTEN_HOME</span><span class="p">}</span><span class="o">/</span><span class="n">ep</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">velox</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">velox_ep</span><span class="p">)</span>
<span class="n">target_link_libraries</span><span class="p">(</span><span class="n">myudf</span> <span class="n">PRIVATE</span> <span class="err">$</span><span class="p">{</span><span class="n">VELOX_LIBRARY</span><span class="p">})</span>
</code></pre></div></div> <h2 id="using-udf-in-gluten"> <a href="#using-udf-in-gluten" class="anchor-heading" aria-labelledby="using-udf-in-gluten"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Using UDF in Gluten </h2> <p>Gluten loads the UDF libraries at runtime. You can upload UDF libraries via <code class="language-plaintext highlighter-rouge">--files</code> or <code class="language-plaintext highlighter-rouge">--archives</code>, and configure the libray paths using the provided Spark configuration, which accepts comma separated list of library paths.</p> <p>Note if running on Yarn client mode, the uploaded files are not reachable on driver side. Users should copy those files to somewhere reachable for driver and set <code class="language-plaintext highlighter-rouge">spark.gluten.sql.columnar.backend.velox.driver.udfLibraryPaths</code>. This configuration is also useful when the <code class="language-plaintext highlighter-rouge">udfLibraryPaths</code> is different between driver side and executor side.</p> <ul> <li>Use <code class="language-plaintext highlighter-rouge">--files</code> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">--files</span> /path/to/gluten/cpp/build/velox/udf/examples/libmyudf.so
<span class="nt">--conf</span> spark.gluten.sql.columnar.backend.velox.udfLibraryPaths<span class="o">=</span>libmyudf.so
<span class="c"># Needed for Yarn client mode</span>
<span class="nt">--conf</span> spark.gluten.sql.columnar.backend.velox.driver.udfLibraryPaths<span class="o">=</span>file:///path/to/libmyudf.so
</code></pre></div> </div> </li> <li>Use <code class="language-plaintext highlighter-rouge">--archives</code> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">--archives</span> /path/to/udf_archives.zip#udf_archives
<span class="nt">--conf</span> spark.gluten.sql.columnar.backend.velox.udfLibraryPaths<span class="o">=</span>udf_archives
<span class="c"># Needed for Yarn client mode</span>
<span class="nt">--conf</span> spark.gluten.sql.columnar.backend.velox.driver.udfLibraryPaths<span class="o">=</span>file:///path/to/udf_archives.zip
</code></pre></div> </div> </li> <li>Specify URI</li> </ul> <p>You can also specify the local or HDFS URIs to the UDF libraries or archives. Local URIs should exist on driver and every worker nodes.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">--conf</span> spark.gluten.sql.columnar.backend.velox.udfLibraryPaths<span class="o">=</span>hdfs://path/to/library_or_archive
</code></pre></div></div> <h2 id="try-the-example"> <a href="#try-the-example" class="anchor-heading" aria-labelledby="try-the-example"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Try the example </h2> <p>We provided an Velox UDF example file <a href="../../cpp/velox/udf/examples/MyUDF.cpp">MyUDF.cpp</a>. After building gluten cpp, you can find the example library at /path/to/gluten/cpp/build/velox/udf/examples/libmyudf.so</p> <p>Start spark-shell or spark-sql with below configuration</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">--files</span> /path/to/gluten/cpp/build/velox/udf/examples/libmyudf.so
<span class="nt">--conf</span> spark.gluten.sql.columnar.backend.velox.udfLibraryPaths<span class="o">=</span>libmyudf.so
</code></pre></div></div> <p>Run query. The functions <code class="language-plaintext highlighter-rouge">myudf1</code> and <code class="language-plaintext highlighter-rouge">myudf2</code> increment the input value by a constant of 5</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">myudf1</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">myudf2</span><span class="p">(</span><span class="mi">100</span><span class="n">L</span><span class="p">)</span>
</code></pre></div></div> <p>The output from spark-shell will be like</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">+</span><span class="c1">----------------+------------------+</span>
<span class="o">|</span><span class="n">udfexpression</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">|</span><span class="n">udfexpression</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">|</span>
<span class="o">+</span><span class="c1">----------------+------------------+</span>
<span class="o">|</span>               <span class="mi">6</span><span class="o">|</span>               <span class="mi">105</span><span class="o">|</span>
<span class="o">+</span><span class="c1">----------------+------------------+</span>
</code></pre></div></div> <h1 id="high-bandwidth-memory-hbm-support"> <a href="#high-bandwidth-memory-hbm-support" class="anchor-heading" aria-labelledby="high-bandwidth-memory-hbm-support"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> High-Bandwidth Memory (HBM) support </h1> <p>Gluten supports allocating memory on HBM. This feature is optional and is disabled by default. It is implemented on top of <a href="http://memkind.github.io/memkind/">Memkind library</a>. You can refer to memkind’s <a href="https://github.com/memkind/memkind#memkind">readme</a> for more details.</p> <h2 id="build-gluten-with-hbm"> <a href="#build-gluten-with-hbm" class="anchor-heading" aria-labelledby="build-gluten-with-hbm"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Build Gluten with HBM </h2> <p>Gluten will internally build and link to a specific version of Memkind library and <a href="https://github.com/open-mpi/hwloc">hwloc</a>. Other dependencies should be installed on Driver and Worker node first:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> autoconf automake g++ libnuma-dev libtool numactl unzip libdaxctl-dev
</code></pre></div></div> <p>After the set-up, you can now build Gluten with HBM. Below command is used to enable this feature</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /path/to/gluten

<span class="c">## The script builds two jars for spark 3.2.2 and 3.3.1.</span>
./dev/buildbundle-veloxbe.sh <span class="nt">--enable_hbm</span><span class="o">=</span>ON
</code></pre></div></div> <h2 id="configure-and-enable-hbm-in-spark-application"> <a href="#configure-and-enable-hbm-in-spark-application" class="anchor-heading" aria-labelledby="configure-and-enable-hbm-in-spark-application"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Configure and enable HBM in Spark Application </h2> <p>At runtime, <code class="language-plaintext highlighter-rouge">MEMKIND_HBW_NODES</code> enviroment variable is detected for configuring HBM NUMA nodes. For the explaination to this variable, please refer to memkind’s manual page. This can be set for all executors through spark conf, e.g. <code class="language-plaintext highlighter-rouge">--conf spark.executorEnv.MEMKIND_HBW_NODES=8-15</code>. Note that memory allocation fallback is also supported and cannot be turned off. If HBM is unavailable or fills up, the allocator will use default(DDR) memory.</p> <h1 id="intel-quickassist-technology-qat-support"> <a href="#intel-quickassist-technology-qat-support" class="anchor-heading" aria-labelledby="intel-quickassist-technology-qat-support"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Intel® QuickAssist Technology (QAT) support </h1> <p>Gluten supports using Intel® QuickAssist Technology (QAT) for data compression during Spark Shuffle. It benefits from QAT Hardware-based acceleration on compression/decompression, and uses Gzip as compression format for higher compression ratio to reduce the pressure on disks and network transmission.</p> <p>This feature is based on QAT driver library and <a href="https://github.com/intel/QATzip">QATzip</a> library. Please manually download QAT driver for your system, and follow its README to build and install on all Driver and Worker node: <a href="https://www.intel.com/content/www/us/en/download/765501/intel-quickassist-technology-driver-for-linux-hw-version-2-0.html?wapkw=quickassist">Intel® QuickAssist Technology Driver for Linux* – HW Version 2.0</a>.</p> <h2 id="software-requirements"> <a href="#software-requirements" class="anchor-heading" aria-labelledby="software-requirements"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Software Requirements </h2> <ul> <li>Download QAT driver for your system, and follow its README to build and install on all Driver and Worker nodes: <a href="https://www.intel.com/content/www/us/en/download/765501/intel-quickassist-technology-driver-for-linux-hw-version-2-0.html?wapkw=quickassist">Intel® QuickAssist Technology Driver for Linux* – HW Version 2.0</a>.</li> <li>Below compression libraries need to be installed on all Driver and Worker nodes: <ul> <li>Zlib* library of version 1.2.7 or higher</li> <li>ZSTD* library of version 1.5.4 or higher</li> <li>LZ4* library</li> </ul> </li> </ul> <h2 id="build-gluten-with-qat"> <a href="#build-gluten-with-qat" class="anchor-heading" aria-labelledby="build-gluten-with-qat"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Build Gluten with QAT </h2> <ol> <li>Setup ICP_ROOT environment variable to the directory where QAT driver is extracted. This environment variable is required during building Gluten and running Spark applications. It’s recommended to put it in .bashrc on Driver and Worker nodes.</li> </ol> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"export ICP_ROOT=/path/to/QAT_driver"</span> <span class="o">&gt;&gt;</span> ~/.bashrc
<span class="nb">source</span> ~/.bashrc

<span class="c"># Also set for root if running as non-root user</span>
<span class="nb">sudo </span>su - 
<span class="nb">echo</span> <span class="s2">"export ICP_ROOT=/path/to/QAT_driver"</span> <span class="o">&gt;&gt;</span> ~/.bashrc
<span class="nb">exit</span>
</code></pre></div></div> <ol> <li><strong>This step is required if your application is running as Non-root user</strong>. The users must be added to the ‘qat’ group after QAT drvier is installed. And change the amount of max locked memory for the username that is included in the group name. This can be done by specifying the limit in /etc/security/limits.conf.</li> </ol> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>su -
usermod <span class="nt">-aG</span> qat username <span class="c"># need relogin to take effect</span>

<span class="c"># To set 500MB add a line like this in /etc/security/limits.conf</span>
<span class="nb">echo</span> <span class="s2">"@qat - memlock 500000"</span> <span class="o">&gt;&gt;</span> /etc/security/limits.conf

<span class="nb">exit</span>
</code></pre></div></div> <ol> <li>Enable huge page. This step is required to execute each time after system reboot. We recommend using systemctl to manage at system startup. You change the values for “max_huge_pages” and “max_huge_pages_per_process” to make sure there are enough resources for your workload. As for Spark applications, one process matches one executor. Within the executor, every task is allocated a maximum of 5 huge pages.</li> </ol> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>su -

<span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; /usr/local/bin/qat_startup.sh
#!/bin/bash
echo 1024 &gt; /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages
rmmod usdm_drv
insmod </span><span class="nv">$ICP_ROOT</span><span class="sh">/build/usdm_drv.ko max_huge_pages=1024 max_huge_pages_per_process=32
</span><span class="no">EOF

</span><span class="nb">chmod</span> +x /usr/local/bin/qat_startup.sh

<span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; /etc/systemd/system/qat_startup.service
[Unit]
Description=Configure QAT

[Service]
ExecStart=/usr/local/bin/qat_startup.sh

[Install]
WantedBy=multi-user.target
</span><span class="no">EOF

</span>systemctl <span class="nb">enable </span>qat_startup.service
systemctl start qat_startup.service <span class="c"># setup immediately</span>
systemctl status qat_startup.service

<span class="nb">exit</span>
</code></pre></div></div> <ol> <li>After the setup, you are now ready to build Gluten with QAT. Use the command below to enable this feature:</li> </ol> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /path/to/gluten

<span class="c">## The script builds two jars for spark 3.2.2 and 3.3.1.</span>
./dev/buildbundle-veloxbe.sh <span class="nt">--enable_qat</span><span class="o">=</span>ON
</code></pre></div></div> <h2 id="enable-qat-with-gzipzstd-for-shuffle-compression"> <a href="#enable-qat-with-gzipzstd-for-shuffle-compression" class="anchor-heading" aria-labelledby="enable-qat-with-gzipzstd-for-shuffle-compression"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Enable QAT with Gzip/Zstd for shuffle compression </h2> <ol> <li>To offload shuffle compression into QAT, first make sure you have the right QAT configuration file at /etc/4xxx_devX.conf. We provide a <a href="../qat/4x16.conf">example configuration file</a>. This configuration sets up to 4 processes that can bind to 1 QAT, and each process can use up to 16 QAT DC instances.</li> </ol> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">## run as root</span>
<span class="c">## Overwrite QAT configuration file.</span>
<span class="nb">cd</span> /etc
<span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>0..7<span class="o">}</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"4xxx_dev</span><span class="nv">$i</span><span class="s2">.conf"</span><span class="p">;</span> <span class="k">done</span> | xargs <span class="nt">-i</span> <span class="nb">cp</span> <span class="nt">-f</span> /path/to/gluten/docs/qat/4x16.conf <span class="o">{}</span>
<span class="c">## Restart QAT after updating configuration files.</span>
adf_ctl restart
</code></pre></div></div> <ol> <li>Check QAT status and make sure the status is up</li> </ol> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adf_ctl status
</code></pre></div></div> <p>The output should be like:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Checking status of all devices.
There is 8 QAT acceleration device(s) in the system:
 qat_dev0 - type: 4xxx,  inst_id: 0,  node_id: 0,  bsf: 0000:6b:00.0,  #accel: 1 #engines: 9 state: up
 qat_dev1 - type: 4xxx,  inst_id: 1,  node_id: 1,  bsf: 0000:70:00.0,  #accel: 1 #engines: 9 state: up
 qat_dev2 - type: 4xxx,  inst_id: 2,  node_id: 2,  bsf: 0000:75:00.0,  #accel: 1 #engines: 9 state: up
 qat_dev3 - type: 4xxx,  inst_id: 3,  node_id: 3,  bsf: 0000:7a:00.0,  #accel: 1 #engines: 9 state: up
 qat_dev4 - type: 4xxx,  inst_id: 4,  node_id: 4,  bsf: 0000:e8:00.0,  #accel: 1 #engines: 9 state: up
 qat_dev5 - type: 4xxx,  inst_id: 5,  node_id: 5,  bsf: 0000:ed:00.0,  #accel: 1 #engines: 9 state: up
 qat_dev6 - type: 4xxx,  inst_id: 6,  node_id: 6,  bsf: 0000:f2:00.0,  #accel: 1 #engines: 9 state: up
 qat_dev7 - type: 4xxx,  inst_id: 7,  node_id: 7,  bsf: 0000:f7:00.0,  #accel: 1 #engines: 9 state: up
</code></pre></div></div> <ol> <li>Extra Gluten configurations are required when starting Spark application</li> </ol> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">--conf</span> spark.gluten.sql.columnar.shuffle.codec<span class="o">=</span><span class="nb">gzip</span> <span class="c"># Valid options are gzip and zstd</span>
<span class="nt">--conf</span> spark.gluten.sql.columnar.shuffle.codecBackend<span class="o">=</span>qat
</code></pre></div></div> <ol> <li>You can use below command to check whether QAT is working normally at run-time. The value of fw_counters should continue to increase during shuffle.</li> </ol> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span> :<span class="p">;</span> <span class="k">do </span><span class="nb">cat</span> /sys/kernel/debug/qat_4xxx_0000:6b:00.0/fw_counters<span class="p">;</span> <span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>
</code></pre></div></div> <h2 id="qat-driver-references"> <a href="#qat-driver-references" class="anchor-heading" aria-labelledby="qat-driver-references"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> QAT driver references </h2> <p><strong>Documentation</strong></p> <p><a href="https://downloadmirror.intel.com/765523/README_QAT20.L.1.0.0-00021.txt">README Text Files (README_QAT20.L.1.0.0-00021.txt)</a></p> <p><strong>Release Notes</strong></p> <p>Check out the <a href="https://www.intel.com/content/www/us/en/content-details/632507/intel-quickassist-technology-intel-qat-software-for-linux-release-notes-hardware-version-2-0.html">Intel® QuickAssist Technology Software for Linux*</a> - Release Notes for the latest changes in this release.</p> <p><strong>Getting Started Guide</strong></p> <p>Check out the <a href="https://www.intel.com/content/www/us/en/content-details/632506/intel-quickassist-technology-intel-qat-software-for-linux-getting-started-guide-hardware-version-2-0.html">Intel® QuickAssist Technology Software for Linux*</a> - Getting Started Guide for detailed installation instructions.</p> <p><strong>Programmer’s Guide</strong></p> <p>Check out the <a href="https://www.intel.com/content/www/us/en/content-details/743912/intel-quickassist-technology-intel-qat-software-for-linux-programmers-guide-hardware-version-2-0.html">Intel® QuickAssist Technology Software for Linux*</a> - Programmer’s Guide for software usage guidelines.</p> <p>For more Intel® QuickAssist Technology resources go to <a href="https://developer.intel.com/quickassist">Intel® QuickAssist Technology (Intel® QAT)</a></p> <h1 id="intel-in-memory-analytics-accelerator-iaaiax-support"> <a href="#intel-in-memory-analytics-accelerator-iaaiax-support" class="anchor-heading" aria-labelledby="intel-in-memory-analytics-accelerator-iaaiax-support"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Intel® In-memory Analytics Accelerator (IAA/IAX) support </h1> <p>Similar to Intel® QAT, Gluten supports using Intel® In-memory Analytics Accelerator (IAA, also called IAX) for data compression during Spark Shuffle. It benefits from IAA Hardware-based acceleration on compression/decompression, and uses Gzip as compression format for higher compression ratio to reduce the pressure on disks and network transmission.</p> <p>This feature is based on Intel® <a href="https://github.com/intel/qpl">QPL</a>.</p> <h2 id="build-gluten-with-iaa"> <a href="#build-gluten-with-iaa" class="anchor-heading" aria-labelledby="build-gluten-with-iaa"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Build Gluten with IAA </h2> <p>Gluten will internally build and link to a specific version of QPL library, but extra environment setup is still required. Please refer to <a href="https://intel.github.io/qpl/documentation/get_started_docs/installation.html">QPL Installation Guide</a> to install dependencies and configure accelerators.</p> <p><strong>This step is required if your application is running as Non-root user</strong>. Create a group for the users who have privilege to use IAA, and grant group iaa read/write access to the IAA Work-Queues.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>groupadd iaa
<span class="nb">sudo </span>usermod <span class="nt">-aG</span> iaa username <span class="c"># need to relogin</span>
<span class="nb">sudo chgrp</span> <span class="nt">-R</span> iaa /dev/iax
<span class="nb">sudo chmod</span> <span class="nt">-R</span> g+rw /dev/iax
</code></pre></div></div> <p>After the set-up, you can now build Gluten with QAT. Below command is used to enable this feature</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /path/to/gluten

<span class="c">## The script builds two jars for spark 3.2.2 and 3.3.1.</span>
./dev/buildbundle-veloxbe.sh <span class="nt">--enable_iaa</span><span class="o">=</span>ON
</code></pre></div></div> <h2 id="enable-iaa-with-gzip-compression-for-shuffle-compression"> <a href="#enable-iaa-with-gzip-compression-for-shuffle-compression" class="anchor-heading" aria-labelledby="enable-iaa-with-gzip-compression-for-shuffle-compression"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Enable IAA with Gzip Compression for shuffle compression </h2> <ol> <li>To enable QAT at run-time, first make sure you have configured the IAA Work-Queues correctly, and the file permissions of /dev/iax/wqX.0 are correct.</li> </ol> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo ls</span> <span class="nt">-l</span> /dev/iax
</code></pre></div></div> <p>The output should be like:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>total 0
crw-rw---- 1 root iaa 509, 0 Apr  5 18:54 wq1.0
crw-rw---- 1 root iaa 509, 5 Apr  5 18:54 wq11.0
crw-rw---- 1 root iaa 509, 6 Apr  5 18:54 wq13.0
crw-rw---- 1 root iaa 509, 7 Apr  5 18:54 wq15.0
crw-rw---- 1 root iaa 509, 1 Apr  5 18:54 wq3.0
crw-rw---- 1 root iaa 509, 2 Apr  5 18:54 wq5.0
crw-rw---- 1 root iaa 509, 3 Apr  5 18:54 wq7.0
crw-rw---- 1 root iaa 509, 4 Apr  5 18:54 wq9.0
</code></pre></div></div> <ol> <li>Extra Gluten configurations are required when starting Spark application</li> </ol> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">--conf</span> spark.gluten.sql.columnar.shuffle.codec<span class="o">=</span><span class="nb">gzip</span>
<span class="nt">--conf</span> spark.gluten.sql.columnar.shuffle.codecBackend<span class="o">=</span>iaa
</code></pre></div></div> <h2 id="iaa-references"> <a href="#iaa-references" class="anchor-heading" aria-labelledby="iaa-references"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> IAA references </h2> <p><strong>Intel® IAA Enabling Guide</strong></p> <p>Check out the <a href="https://www.intel.com/content/www/us/en/developer/articles/technical/intel-iaa-enabling-guide.html">Intel® In-Memory Analytics Accelerator (Intel® IAA) Enabling Guide</a></p> <p><strong>Intel® QPL Documentation</strong></p> <p>Check out the <a href="https://intel.github.io/qpl/index.html">Intel® Query Processing Library (Intel® QPL) Documentation</a></p> <h1 id="test-tpc-h-or-tpc-ds-on-gluten-with-velox-backend"> <a href="#test-tpc-h-or-tpc-ds-on-gluten-with-velox-backend" class="anchor-heading" aria-labelledby="test-tpc-h-or-tpc-ds-on-gluten-with-velox-backend"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Test TPC-H or TPC-DS on Gluten with Velox backend </h1> <p>All TPC-H and TPC-DS queries are supported in Gluten Velox backend.</p> <h2 id="data-preparation"> <a href="#data-preparation" class="anchor-heading" aria-labelledby="data-preparation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Data preparation </h2> <p>The data generation scripts are <a href="../../tools/workload/tpch/gen_data/parquet_dataset/tpch_datagen_parquet.sh">TPC-H dategen script</a> and <a href="../../tools/workload/tpcds/gen_data/parquet_dataset/tpcds_datagen_parquet.sh">TPC-DS dategen script</a>.</p> <p>The used TPC-H and TPC-DS queries are the original ones, and can be accessed from <a href="../../gluten-core/src/test/resources/tpcds-queries/tpcds.queries.original">TPC-DS queries</a> and <a href="../../gluten-core/src/test/resources/tpch-queries">TPC-H queries</a>.</p> <p>Some other versions of TPC-DS queries are also provided, but are <strong>not</strong> recommended for testing, including:</p> <ul> <li>the modified TPC-DS queries with “Decimal-to-Double”: <a href="../../gluten-core/src/test/resources/tpcds-queries/tpcds.queries.no-decimal">TPC-DS non-decimal queries</a> (outdated).</li> </ul> <h2 id="submit-the-spark-sql-job"> <a href="#submit-the-spark-sql-job" class="anchor-heading" aria-labelledby="submit-the-spark-sql-job"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Submit the Spark SQL job </h2> <p>Submit test script from spark-shell. You can find the scala code to <a href="../../tools/workload/tpch/run_tpch/tpch_parquet.scala">Run TPC-H</a> as an example. Please remember to modify the location of TPC-H files as well as TPC-H queries before you run the testing.</p> <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">parquet_file_path</span> <span class="k">=</span> <span class="s">"/PATH/TO/TPCH_PARQUET_PATH"</span>
<span class="k">var</span> <span class="n">gluten_root</span> <span class="k">=</span> <span class="s">"/PATH/TO/GLUTEN"</span>
</code></pre></div></div> <p>Below script shows an example about how to run the testing, you should modify the parameters such as executor cores, memory, offHeap size based on your environment.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span>GLUTEN_JAR <span class="o">=</span> /PATH/TO/GLUTEN/package/target/&lt;gluten-jar&gt;
<span class="nb">cat </span>tpch_parquet.scala | spark-shell <span class="nt">--name</span> tpch_powertest_velox <span class="se">\</span>
  <span class="nt">--master</span> yarn <span class="nt">--deploy-mode</span> client <span class="se">\</span>
  <span class="nt">--conf</span> spark.plugins<span class="o">=</span>io.glutenproject.GlutenPlugin <span class="se">\</span>
  <span class="nt">--conf</span> spark.driver.extraClassPath<span class="o">=</span><span class="k">${</span><span class="nv">GLUTEN_JAR</span><span class="k">}</span> <span class="se">\</span>
  <span class="nt">--conf</span> spark.executor.extraClassPath<span class="o">=</span><span class="k">${</span><span class="nv">GLUTEN_JAR</span><span class="k">}</span> <span class="se">\</span>
  <span class="nt">--conf</span> spark.memory.offHeap.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--conf</span> spark.memory.offHeap.size<span class="o">=</span>20g <span class="se">\</span>
  <span class="nt">--conf</span> spark.gluten.sql.columnar.forceShuffledHashJoin<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--conf</span> spark.shuffle.manager<span class="o">=</span>org.apache.spark.shuffle.sort.ColumnarShuffleManager <span class="se">\</span>
  <span class="nt">--num-executors</span> 6 <span class="se">\</span>
  <span class="nt">--executor-cores</span> 6 <span class="se">\</span>
  <span class="nt">--driver-memory</span> 20g <span class="se">\</span>
  <span class="nt">--executor-memory</span> 25g <span class="se">\</span>
  <span class="nt">--conf</span> spark.executor.memoryOverhead<span class="o">=</span>5g <span class="se">\</span>
  <span class="nt">--conf</span> spark.driver.maxResultSize<span class="o">=</span>32g
</code></pre></div></div> <p>Refer to <a href="../Configuration.md">Gluten configuration</a> for more details.</p> <h2 id="result"> <a href="#result" class="anchor-heading" aria-labelledby="result"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Result </h2> <p><em>wholestagetransformer</em> indicates that the offload works.</p> <p><img src="/assets/images/TPC-H_Q6_DAG.png" alt="TPC-H Q6" /></p> <h2 id="performance"> <a href="#performance" class="anchor-heading" aria-labelledby="performance"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Performance </h2> <p>Below table shows the TPC-H Q1 and Q6 Performance in a multiple-thread test (–num-executors 6 –executor-cores 6) for Velox and vanilla Spark. Both Parquet and ORC datasets are sf1024.</p> <div class="table-wrapper"><table> <thead> <tr> <th>Query Performance (s)</th> <th>Velox (ORC)</th> <th>Vanilla Spark (Parquet)</th> <th>Vanilla Spark (ORC)</th> </tr> </thead> <tbody> <tr> <td>TPC-H Q6</td> <td>13.6</td> <td>21.6</td> <td>34.9</td> </tr> <tr> <td>TPC-H Q1</td> <td>26.1</td> <td>76.7</td> <td>84.9</td> </tr> </tbody> </table></div> <h1 id="external-reference-setup"> <a href="#external-reference-setup" class="anchor-heading" aria-labelledby="external-reference-setup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> External reference setup </h1> <p>TO ease your first-hand experience of using Gluten, we have set up an external reference cluster. If you are interested, please contact Weiting.Chen@intel.com.</p> <h1 id="gluten-ui"> <a href="#gluten-ui" class="anchor-heading" aria-labelledby="gluten-ui"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Gluten UI </h1> <h2 id="gluten-event"> <a href="#gluten-event" class="anchor-heading" aria-labelledby="gluten-event"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Gluten event </h2> <p>Gluten provides two events <code class="language-plaintext highlighter-rouge">GlutenBuildInfoEvent</code> and <code class="language-plaintext highlighter-rouge">GlutenPlanFallbackEvent</code>:</p> <ul> <li> <p>GlutenBuildInfoEvent, it contains the Gluten build information so that we are able to be aware of the environment when doing some debug. It includes <code class="language-plaintext highlighter-rouge">Java Version</code>, <code class="language-plaintext highlighter-rouge">Scala Version</code>, <code class="language-plaintext highlighter-rouge">GCC Version</code>, <code class="language-plaintext highlighter-rouge">Gluten Version</code>, <code class="language-plaintext highlighter-rouge">Spark Version</code>, <code class="language-plaintext highlighter-rouge">Hadoop Version</code>, <code class="language-plaintext highlighter-rouge">Gluten Revision</code>, <code class="language-plaintext highlighter-rouge">Backend</code>, <code class="language-plaintext highlighter-rouge">Backend Revision</code>, etc.</p> </li> <li> <p>GlutenPlanFallbackEvent, it contains the fallback information for each query execution. Note, if the query execution is in AQE, then Gluten will post it for each stage.</p> </li> </ul> <p>Developers can register <code class="language-plaintext highlighter-rouge">SparkListener</code> to handle these two Gluten events.</p> <h2 id="sql-tab"> <a href="#sql-tab" class="anchor-heading" aria-labelledby="sql-tab"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> SQL tab </h2> <p>Gluten provides a tab based on Spark UI, named <code class="language-plaintext highlighter-rouge">Gluten SQL / DataFrame</code></p> <p><img src="/assets/images/gluten-ui.png" alt="Gluten-UI" /></p> <p>This tab contains two parts:</p> <ol> <li>The Gluten build information.</li> <li>SQL/Dataframe queries fallback information.</li> </ol> <p>If you want to disable Gluten UI, add a config when submitting <code class="language-plaintext highlighter-rouge">--conf spark.gluten.ui.enabled=false</code>.</p> <h2 id="history-server"> <a href="#history-server" class="anchor-heading" aria-labelledby="history-server"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> History server </h2> <p>Gluten UI also supports Spark history server. Add gluten-ui jar into the history server classpath, e.g., $SPARK_HOME/jars, then restart history server.</p> <h2 id="native-plan-string"> <a href="#native-plan-string" class="anchor-heading" aria-labelledby="native-plan-string"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Native plan string </h2> <p>Gluten supports inject native plan string into Spark explain with formatted mode by setting <code class="language-plaintext highlighter-rouge">--conf spark.gluten.sql.injectNativePlanStringToExplain=true</code>. Here is an example, how Gluten show the native plan string.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(9) WholeStageCodegenTransformer (2)
Input [6]: [c1#0L, c2#1L, c3#2L, c1#3L, c2#4L, c3#5L]
Arguments: false
Native Plan:
-- Project[expressions: (n3_6:BIGINT, "n0_0"), (n3_7:BIGINT, "n0_1"), (n3_8:BIGINT, "n0_2"), (n3_9:BIGINT, "n1_0"), (n3_10:BIGINT, "n1_1"), (n3_11:BIGINT, "n1_2")] -&gt; n3_6:BIGINT, n3_7:BIGINT, n3_8:BIGINT, n3_9:BIGINT, n3_10:BIGINT, n3_11:BIGINT
  -- HashJoin[INNER n1_1=n0_1] -&gt; n1_0:BIGINT, n1_1:BIGINT, n1_2:BIGINT, n0_0:BIGINT, n0_1:BIGINT, n0_2:BIGINT
    -- TableScan[table: hive_table, range filters: [(c2, Filter(IsNotNull, deterministic, null not allowed))]] -&gt; n1_0:BIGINT, n1_1:BIGINT, n1_2:BIGINT
    -- ValueStream[] -&gt; n0_0:BIGINT, n0_1:BIGINT, n0_2:BIGINT
</code></pre></div></div> <h2 id="native-plan-with-stats"> <a href="#native-plan-with-stats" class="anchor-heading" aria-labelledby="native-plan-with-stats"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Native plan with stats </h2> <p>Gluten supports print native plan with stats to executor system output stream by setting <code class="language-plaintext highlighter-rouge">--conf spark.gluten.sql.debug=true</code>. Note that, the plan string with stats is task level which may cause executor log size big. Here is an example, how Gluten show the native plan string with stats.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>I20231121 10:19:42.348845 90094332 WholeStageResultIterator.cc:220] Native Plan with stats for: [Stage: 1 TID: 16]
-- Project[expressions: (n3_6:BIGINT, "n0_0"), (n3_7:BIGINT, "n0_1"), (n3_8:BIGINT, "n0_2"), (n3_9:BIGINT, "n1_0"), (n3_10:BIGINT, "n1_1"), (n3_11:BIGINT, "n1_2")] -&gt; n3_6:BIGINT, n3_7:BIGINT, n3_8:BIGINT, n3_9:BIGINT, n3_10:BIGINT, n3_11:BIGINT
   Output: 27 rows (3.56KB, 3 batches), Cpu time: 10.58us, Blocked wall time: 0ns, Peak memory: 0B, Memory allocations: 0, Threads: 1
      queuedWallNanos              sum: 2.00us, count: 1, min: 2.00us, max: 2.00us
      runningAddInputWallNanos     sum: 626ns, count: 1, min: 626ns, max: 626ns
      runningFinishWallNanos       sum: 0ns, count: 1, min: 0ns, max: 0ns
      runningGetOutputWallNanos    sum: 5.54us, count: 1, min: 5.54us, max: 5.54us
  -- HashJoin[INNER n1_1=n0_1] -&gt; n1_0:BIGINT, n1_1:BIGINT, n1_2:BIGINT, n0_0:BIGINT, n0_1:BIGINT, n0_2:BIGINT
     Output: 27 rows (3.56KB, 3 batches), Cpu time: 223.00us, Blocked wall time: 0ns, Peak memory: 93.12KB, Memory allocations: 15
     HashBuild: Input: 10 rows (960B, 10 batches), Output: 0 rows (0B, 0 batches), Cpu time: 185.67us, Blocked wall time: 0ns, Peak memory: 68.00KB, Memory allocations: 2, Threads: 1
        distinctKey0                 sum: 4, count: 1, min: 4, max: 4
        hashtable.capacity           sum: 4, count: 1, min: 4, max: 4
        hashtable.numDistinct        sum: 10, count: 1, min: 10, max: 10
        hashtable.numRehashes        sum: 1, count: 1, min: 1, max: 1
        queuedWallNanos              sum: 0ns, count: 1, min: 0ns, max: 0ns
        rangeKey0                    sum: 4, count: 1, min: 4, max: 4
        runningAddInputWallNanos     sum: 1.27ms, count: 1, min: 1.27ms, max: 1.27ms
        runningFinishWallNanos       sum: 0ns, count: 1, min: 0ns, max: 0ns
        runningGetOutputWallNanos    sum: 1.29us, count: 1, min: 1.29us, max: 1.29us
     H23/11/21 10:19:42 INFO TaskSetManager: Finished task 3.0 in stage 1.0 (TID 13) in 335 ms on 10.221.97.35 (executor driver) (1/10)
ashProbe: Input: 9 rows (864B, 3 batches), Output: 27 rows (3.56KB, 3 batches), Cpu time: 37.33us, Blocked wall time: 0ns, Peak memory: 25.12KB, Memory allocations: 13, Threads: 1
        dynamicFiltersProduced       sum: 1, count: 1, min: 1, max: 1
        queuedWallNanos              sum: 0ns, count: 1, min: 0ns, max: 0ns
        runningAddInputWallNanos     sum: 4.54us, count: 1, min: 4.54us, max: 4.54us
        runningFinishWallNanos       sum: 83ns, count: 1, min: 83ns, max: 83ns
        runningGetOutputWallNanos    sum: 29.08us, count: 1, min: 29.08us, max: 29.08us
    -- TableScan[table: hive_table, range filters: [(c2, Filter(IsNotNull, deterministic, null not allowed))]] -&gt; n1_0:BIGINT, n1_1:BIGINT, n1_2:BIGINT
       Input: 9 rows (864B, 3 batches), Output: 9 rows (864B, 3 batches), Cpu time: 630.75us, Blocked wall time: 0ns, Peak memory: 2.44KB, Memory allocations: 63, Threads: 1, Splits: 3
          dataSourceWallNanos              sum: 102.00us, count: 1, min: 102.00us, max: 102.00us
          dynamicFiltersAccepted           sum: 1, count: 1, min: 1, max: 1
          flattenStringDictionaryValues    sum: 0, count: 1, min: 0, max: 0
          ioWaitNanos                      sum: 312.00us, count: 1, min: 312.00us, max: 312.00us
          localReadBytes                   sum: 0B, count: 1, min: 0B, max: 0B
          numLocalRead                     sum: 0, count: 1, min: 0, max: 0
          numPrefetch                      sum: 0, count: 1, min: 0, max: 0
          numRamRead                       sum: 0, count: 1, min: 0, max: 0
          numStorageRead                   sum: 6, count: 1, min: 6, max: 6
          overreadBytes                    sum: 0B, count: 1, min: 0B, max: 0B
          prefetchBytes                    sum: 0B, count: 1, min: 0B, max: 0B
          queryThreadIoLatency             sum: 12, count: 1, min: 12, max: 12
          ramReadBytes                     sum: 0B, count: 1, min: 0B, max: 0B
          runningAddInputWallNanos         sum: 0ns, count: 1, min: 0ns, max: 0ns
          runningFinishWallNanos           sum: 125ns, count: 1, min: 125ns, max: 125ns
          runningGetOutputWallNanos        sum: 1.07ms, count: 1, min: 1.07ms, max: 1.07ms
          skippedSplitBytes                sum: 0B, count: 1, min: 0B, max: 0B
          skippedSplits                    sum: 0, count: 1, min: 0, max: 0
          skippedStrides                   sum: 0, count: 1, min: 0, max: 0
          storageReadBytes                 sum: 3.44KB, count: 1, min: 3.44KB, max: 3.44KB
          totalScanTime                    sum: 0ns, count: 1, min: 0ns, max: 0ns
    -- ValueStream[] -&gt; n0_0:BIGINT, n0_1:BIGINT, n0_2:BIGINT
       Input: 0 rows (0B, 0 batches), Output: 10 rows (960B, 10 batches), Cpu time: 1.03ms, Blocked wall time: 0ns, Peak memory: 0B, Memory allocations: 0, Threads: 1
          runningAddInputWallNanos     sum: 0ns, count: 1, min: 0ns, max: 0ns
          runningFinishWallNanos       sum: 54.62us, count: 1, min: 54.62us, max: 54.62us
          runningGetOutputWallNanos    sum: 1.10ms, count: 1, min: 1.10ms, max: 1.10ms
</code></pre></div></div> <h1 id="gluten-implicits"> <a href="#gluten-implicits" class="anchor-heading" aria-labelledby="gluten-implicits"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Gluten Implicits </h1> <p>Gluten provides a helper class to get the fallback summary from a Spark Dataset.</p> <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">org.apache.spark.sql.execution.GlutenImplicits._</span>
<span class="k">val</span> <span class="nv">df</span> <span class="k">=</span> <span class="nv">spark</span><span class="o">.</span><span class="py">sql</span><span class="o">(</span><span class="s">"SELECT * FROM t"</span><span class="o">)</span>
<span class="nv">df</span><span class="o">.</span><span class="py">fallbackSummary</span>
</code></pre></div></div> <p>Note that, if AQE is enabled, but the query is not materialized, then it will re-plan the query execution with disabled AQE. It is a workaround to get the final plan, and it may cause the inconsistent results with a materialized query. However, we have no choice.</p> </main> <hr> <footer> <p><a href="#top" id="back-to-top">Back to top</a></p> <a href="https://incubator.apache.org/"><img src="/assets/images/apache-incubator.svg" style="width:300px"></a> <p class="text-small text-grey-dk-100 mb-0">Copyright © 2024 The Apache Software Foundation, Licensed under the Apache License, Version 2.0. Apache Gluten, Gluten, Apache, the Apache feather logo, and the Apache Gluten project logo are either registered trademarks or trademarks of the Apache Software Foundation in the United States and/or other countries.</p> <p class="text-small text-grey-dk-100 mb-0">Apache Gluten is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</p> <p class="text-small text-grey-dk-100 mb-0"><a href="https://privacy.apache.org/policies/privacy-policy-public.html">Privacy Policy</a></p> <div class="d-flex mt-2"> </div> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
