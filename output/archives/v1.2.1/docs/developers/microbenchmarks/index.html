<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul:nth-of-type(2) > li > ul > li > a, .site-nav > ul:nth-of-type(2) > li > ul > li > ul > li > a, .site-nav > ul:nth-of-type(2) > li > ul > li > ul > li > ul > li > a, .site-nav > ul:nth-of-type(2) > li > ul > li > ul > li > ul > li > ul > li > a, .site-nav > ul:nth-of-type(2) > li > ul > li > ul > li > ul > li > ul > li > ul > li:not(:nth-child(3)) > a, .site-nav > ul:nth-of-type(2) > li > ul > li > ul > li > ul > li > ul > li > ul > li > ul > li a { background-image: none; } .site-nav > ul:not(:nth-of-type(2)) a, .site-nav li.external a { background-image: none; } .site-nav > ul:nth-of-type(2) > li > ul > li:nth-child(2) > ul > li:nth-child(2) > ul > li:nth-child(1) > ul > li:nth-child(3) > ul > li:nth-child(3) > a { font-weight: 600; text-decoration: none; } .site-nav > ul.nav-category-list > li > button svg, .site-nav > ul:nth-of-type(2) > li > ul > li:nth-child(2) > button svg, .site-nav > ul:nth-of-type(2) > li > ul > li:nth-child(2) > ul > li:nth-child(2) > button svg, .site-nav > ul:nth-of-type(2) > li > ul > li:nth-child(2) > ul > li:nth-child(2) > ul > li:nth-child(1) > button svg, .site-nav > ul:nth-of-type(2) > li > ul > li:nth-child(2) > ul > li:nth-child(2) > ul > li:nth-child(1) > ul > li:nth-child(3) > button svg, .site-nav > ul:nth-of-type(2) > li > ul > li:nth-child(2) > ul > li:nth-child(2) > ul > li:nth-child(1) > ul > li:nth-child(3) > ul > li:nth-child(3) > button svg { transform: rotate(-90deg); } .site-nav > ul.nav-category-list > li.nav-list-item > ul.nav-list, .site-nav > ul:nth-of-type(2) > li > ul > li.nav-list-item:nth-child(2) > ul.nav-list, .site-nav > ul:nth-of-type(2) > li > ul > li.nav-list-item:nth-child(2) > ul.nav-list > li.nav-list-item:nth-child(2) > ul.nav-list, .site-nav > ul:nth-of-type(2) > li > ul > li.nav-list-item:nth-child(2) > ul.nav-list > li.nav-list-item:nth-child(2) > ul.nav-list > li.nav-list-item:nth-child(1) > ul.nav-list, .site-nav > ul:nth-of-type(2) > li > ul > li.nav-list-item:nth-child(2) > ul.nav-list > li.nav-list-item:nth-child(2) > ul.nav-list > li.nav-list-item:nth-child(1) > ul.nav-list > li.nav-list-item:nth-child(3) > ul.nav-list, .site-nav > ul:nth-of-type(2) > li > ul > li.nav-list-item:nth-child(2) > ul.nav-list > li.nav-list-item:nth-child(2) > ul.nav-list > li.nav-list-item:nth-child(1) > ul.nav-list > li.nav-list-item:nth-child(3) > ul.nav-list > li.nav-list-item:nth-child(3) > ul.nav-list { display: block; } </style> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Micro Benchmarks for Velox Backend(v1.2.1) | Apache Gluten incubating</title> <meta name="generator" content="Jekyll v3.9.3" /> <meta property="og:title" content="Micro Benchmarks for Velox Backend(v1.2.1)" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Generate Micro Benchmarks for Velox Backend" /> <meta property="og:description" content="Generate Micro Benchmarks for Velox Backend" /> <link rel="canonical" href="https://gluten.apache.org/archives/v1.2.1/docs/developers/microbenchmarks/" /> <meta property="og:url" content="https://gluten.apache.org/archives/v1.2.1/docs/developers/microbenchmarks/" /> <meta property="og:site_name" content="Apache Gluten incubating" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2025-08-07T20:55:29+00:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Micro Benchmarks for Velox Backend(v1.2.1)" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-08-07T20:55:29+00:00","datePublished":"2025-08-07T20:55:29+00:00","description":"Generate Micro Benchmarks for Velox Backend","headline":"Micro Benchmarks for Velox Backend(v1.2.1)","mainEntityOfPage":{"@type":"WebPage","@id":"https://gluten.apache.org/archives/v1.2.1/docs/developers/microbenchmarks/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://gluten.apache.org/assets/images/gluten-logo-blue.png"}},"url":"https://gluten.apache.org/archives/v1.2.1/docs/developers/microbenchmarks/"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"> <div class="site-logo" role="img" aria-label="Apache Gluten incubating"></div> </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/downloads/" class="nav-list-link">Downloads</a></li><li class="nav-list-item"><a href="/blog/" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/references/" class="nav-list-link">Gluten References</a></li><li class="nav-list-item"><a href="/poweredby/" class="nav-list-link">Powered by Gluten</a></li><li class="nav-list-item"><a href="/contributing/" class="nav-list-link">Contributing to Gluten</a></li><li class="nav-list-item"><a href="/contact/" class="nav-list-link">Contact Us</a></li><li class="nav-list-item"><a href="/about/" class="nav-list-link">About</a></li></ul> <ul class="nav-list nav-category-list"> <li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="Toggle collection Documentations" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><div class="nav-category">Documentations</div> <ul class="nav-list"><li class="nav-list-item"><a href="/docs/latest.html" class="nav-list-link">Documentation(Latest)</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Archives category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/" class="nav-list-link">Archives</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in v1.1.1 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.1.1/" class="nav-list-link">v1.1.1</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in v1.1.1/Documentation category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.1.1/docs/" class="nav-list-link">v1.1.1/Documentation</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in v1.1.1/Velox Backend category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.1.1/docs/velox/" class="nav-list-link">v1.1.1/Velox Backend</a><ul class="nav-list"><li class="nav-list-item"><a href="/archives/v1.1.1/docs/velox/getting-started/" class="nav-list-link">v1.1.1/Getting-Started with Velox Backend</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/docs/velox/build_parameters/" class="nav-list-link">v1.1.1/Build Parameters for Velox Backend</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/docs/velox/s3/" class="nav-list-link">v1.1.1/Using S3 with Gluten</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/docs/velox/gcs/" class="nav-list-link">v1.1.1/Using GCS with Gluten</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in v1.1.1/ClickHouse Backend category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.1.1/docs/clickhouse/" class="nav-list-link">v1.1.1/ClickHouse Backend</a><ul class="nav-list"><li class="nav-list-item"><a href="/archives/v1.1.1/docs/clickhouse/getting-started/" class="nav-list-link">v1.1.1/Getting Started with ClickHouse Backend</a></li></ul></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in v1.1.1/Developers category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.1.1/developers/" class="nav-list-link">v1.1.1/Developers</a><ul class="nav-list"><li class="nav-list-item"><a href="/archives/v1.1.1/developers/newto/" class="nav-list-link">v1.1.1/New To Gluten</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/howto/" class="nav-list-link">v1.1.1/How To Use Gluten</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/microbenchmark/" class="nav-list-link">v1.1.1/Micro Benchmarks for Velox Backend</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/cpp_code_style/" class="nav-list-link">v1.1.1/CPP Code Style</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/velox_function_development/" class="nav-list-link">v1.1.1/Velox Function Development</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/docker_ubuntu/" class="nav-list-link">v1.1.1/Docker script for Ubuntu 22.04/20.04</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/docker_centos8" class="nav-list-link">v1.1.1/Docker script for CentOS 8</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/docker_centos7/" class="nav-list-link">v1.1.1/Docker script for CentOS 7</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/substrait/" class="nav-list-link">v1.1.1/Substrait Modifications</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/howtorelease/" class="nav-list-link">v1.1.1/How To Release</a></li></ul></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in v1.2.1 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.2.1/" class="nav-list-link">v1.2.1</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Documentations(v1.2.1) category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.2.1/docs/" class="nav-list-link">Documentations(v1.2.1)</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Getting-Started(v1.2.1) category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.2.1/docs/getting-started/" class="nav-list-link">Getting-Started(v1.2.1)</a><ul class="nav-list"><li class="nav-list-item"><a href="/archives/v1.2.1/docs/getting-started/velox-backend/" class="nav-list-link">Getting Start with Velox Backend(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/getting-started/clickhouse-backend/" class="nav-list-link">Getting start with ClickHouse Backend(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/getting-started/build-guide/" class="nav-list-link">Build Parameters for Velox Backend(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/getting-started/s3/" class="nav-list-link">Using S3 with Gluten(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/getting-started/gcs/" class="nav-list-link">Using GCS with Gluten(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/getting-started/abfs/" class="nav-list-link">Using ABFS with Gluten(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/getting-started/localcache/" class="nav-list-link">Velox Local Caching(v1.2.1)</a></li></ul></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/configuration/" class="nav-list-link">Configuration(v1.2.1)</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Developers(v1.2.1) category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.2.1/docs/developers/" class="nav-list-link">Developers(v1.2.1)</a><ul class="nav-list"><li class="nav-list-item"><a href="/archives/v1.2.1/docs/developers/how-to-use/" class="nav-list-link">How To Use Gluten(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/developers/new-to/" class="nav-list-link">New To Gluten(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/developers/microbenchmarks/" class="nav-list-link">Micro Benchmarks for Velox Backend(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/developers/cpp-code-style/" class="nav-list-link">CPP Code Style(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/developers/velox-function-dev/" class="nav-list-link">Velox Function Development(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/developers/docker-ubuntu/" class="nav-list-link">Docker script for Ubuntu 22.04/20.04(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/developers/docker-centos7/" class="nav-list-link">Docker script for CentOS 7(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/developers/docker-centos8/" class="nav-list-link">Docker script for CentOS 8(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/developers/substrait/" class="nav-list-link">Substrait Modifications(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/developers/how-to-release/" class="nav-list-link">How To Release(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/developers/how-to-security-scan/" class="nav-list-link">How To Scan Security issues(v1.2.1)</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Velox Backend(v1.2.1) category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.2.1/docs/velox-backend/" class="nav-list-link">Velox Backend(v1.2.1)</a><ul class="nav-list"><li class="nav-list-item"><a href="/archives/v1.2.1/docs/velox-backend/support/" class="nav-list-link">Supported Operators & Functions(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/velox-backend/limitations/" class="nav-list-link">Limitations(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/velox-backend/troubleshooting/" class="nav-list-link">Troubleshooting(v1.2.1)</a></li><li class="nav-list-item"><a href="/archives/v1.2.1/docs/velox-backend/udf/" class="nav-list-link">Velox UDF(v1.2.1)</a></li></ul></li></ul></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in v1.3.0 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.3.0/" class="nav-list-link">v1.3.0</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Getting-Started category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.3.0/getting-started" class="nav-list-link">Getting-Started</a><ul class="nav-list"><li class="nav-list-item"><a href="/archives/v1.3.0/getting-started/velox-backend/" class="nav-list-link">Getting Start with Velox Backend</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/getting-started/clickhouse-backend/" class="nav-list-link">Getting start with ClickHouse Backend</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/getting-started/build-guide/" class="nav-list-link">Build Parameters for Velox Backend</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/getting-started/s3/" class="nav-list-link">Using S3 with Gluten</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/getting-started/gcs/" class="nav-list-link">Using GCS with Gluten</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/getting-started/abfs/" class="nav-list-link">Using ABFS with Gluten</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/getting-started/localcache/" class="nav-list-link">Velox Local Caching</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Velox Backend category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.3.0/velox-backend" class="nav-list-link">Velox Backend</a><ul class="nav-list"><li class="nav-list-item"><a href="/archives/v1.3.0/velox-backend/support/" class="nav-list-link">Supported Operators & Functions</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/velox-backend/limitations/" class="nav-list-link">Limitations</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/velox-backend/troubleshooting/" class="nav-list-link">Troubleshooting</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/velox-backend/udf/" class="nav-list-link">Velox UDF</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Developers category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.3.0/developers" class="nav-list-link">Developers</a><ul class="nav-list"><li class="nav-list-item"><a href="/archives/v1.3.0/developers/how-to-use/" class="nav-list-link">How To Use Gluten</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/developers/new-to/" class="nav-list-link">New To Gluten</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/developers/microbenchmarks/" class="nav-list-link">Micro Benchmarks for Velox Backend</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/developers/velox-function-dev/" class="nav-list-link">Velox Function Development</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/developers/docker-ubuntu/" class="nav-list-link">Docker script for Ubuntu 22.04/20.04</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/developers/docker-centos7/" class="nav-list-link">Docker script for CentOS 7</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/developers/docker-centos8/" class="nav-list-link">Docker script for CentOS 8</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/developers/substrait/" class="nav-list-link">Substrait Modifications</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/developers/how-to-security-scan/" class="nav-list-link">How To Scan Security issues</a></li></ul></li><li class="nav-list-item"><a href="/archives/v1.3.0/configuration" class="nav-list-link">Configuration</a></li><li class="nav-list-item"><a href="/archives/v1.3.0/developers/cpp-code-style/" class="nav-list-link">CPP Code Style</a></li></ul></li></ul></li></ul> </li> </ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Apache Gluten incubating" aria-label="Search Apache Gluten incubating" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <style> /* Style The Dropdown Button */ .dropbtn { background-color: #0000ff80; color: white; padding: 22px; width: 100%; font-size: 14px; border: none; cursor: pointer; } /* The container <div> - needed to position the dropdown content */ .dropdown { position: relative; display: inline-block; } /* Dropdown Content (Hidden by Default) */ .dropdown-content { display: none; position: absolute; background-color: #f9f9f9; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; } /* Links inside the dropdown */ .dropdown-content a { color: black; padding: 12px 14px; text-decoration: none; display: block; } /* Change color of dropdown links on hover */ .dropdown-content a:hover {background-color: #f1f1f1} /* Show the dropdown menu on hover */ .dropdown:hover .dropdown-content { display: block; } /* Change the background color of the dropdown button when the dropdown content is shown */ .dropdown:hover .dropbtn { background-color: #0000ff; } </style> <!-- Collect the nav links, forms, and other content for toggling --> <div class="dropdown" id="apache-navbar" style="float:left;"> <button class="dropbtn">ASF</button> <div class="dropdown-content"> <a class="dropdown-item" href="https://www.apache.org/">Foundation</a> <a class="dropdown-item" href="https://www.apache.org/events/current-event.html">Event</a> <a class="dropdown-item" href="https://www.apache.org/licenses/">License</a> <a class="dropdown-item" href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a> <a class="dropdown-item" href="https://www.apache.org/security/">Security</a> <a class="dropdown-item" href="https://privacy.apache.org/policies/privacy-policy-public.html">Privacy</a> <a class="dropdown-item" href="https://www.apache.org/foundation/thanks.html">Thanks</a> </div> </div><!-- /.navbar-collapse --> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//github.com/apache/incubator-gluten" class="site-button" target="_blank" rel="noopener noreferrer" > Apache Gluten Github </a> </li> </ul> </nav> </div> <div class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/archives/">Archives</a></li> <li class="breadcrumb-nav-list-item"><a href="/archives/v1.2.1/">v1.2.1</a></li> <li class="breadcrumb-nav-list-item"><a href="/archives/v1.2.1/docs/">Documentations(v1.2.1)</a></li> <li class="breadcrumb-nav-list-item"><a href="/archives/v1.2.1/docs/developers/">Developers(v1.2.1)</a></li> <li class="breadcrumb-nav-list-item"><span>Micro Benchmarks for Velox Backend(v1.2.1)</span></li> </ol> </nav> <div id="main-content" class="main-content"> <main> <h1 id="generate-micro-benchmarks-for-velox-backend"> <a href="#generate-micro-benchmarks-for-velox-backend" class="anchor-heading" aria-labelledby="generate-micro-benchmarks-for-velox-backend"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Generate Micro Benchmarks for Velox Backend </h1> <p><strong>This document explains how to use the existing micro benchmark template in Gluten Cpp.</strong></p> <p>A micro benchmark for Velox backend is provided in Gluten Cpp to simulate the execution of a first or middle stage in Spark. It serves as a more convenient alternative to debug in Gluten Cpp comparing with directly debugging in a Spark job. Developers can use it to create their own workloads, debug in native process, profile the hotspot and do optimizations.</p> <p>To simulate a first stage, you need to dump the Substrait plan and input split info into two JSON files. The input URIs of the splits should be exising file locations, which can be either local or HDFS paths.</p> <p>To simulate a middle stage, in addition to the JSON file, you also need to save the input data of this stage into Parquet files. The benchmark will load the data into Arrow format, then add Arrow2Velox to feed the data into Velox pipeline to reproduce the reducer stage. Shuffle exchange is not included.</p> <p>Please refer to the sections below to learn how to dump the Substrait plan and create the input data files.</p> <h2 id="try-the-example"> <a href="#try-the-example" class="anchor-heading" aria-labelledby="try-the-example"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Try the example </h2> <p>To run a micro benchmark, user should provide one file that contains the Substrait plan in JSON format, and optional one or more input data files in parquet format. The commands below help to generate example input files:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /path/to/gluten/
./dev/buildbundle-veloxbe.sh <span class="nt">--build_tests</span><span class="o">=</span>ON <span class="nt">--build_benchmarks</span><span class="o">=</span>ON

<span class="c"># Run test to generate input data files. If you are using spark 3.3, replace -Pspark-3.2 with -Pspark-3.3</span>
mvn <span class="nb">test</span> <span class="nt">-Pspark-3</span>.2 <span class="nt">-Pbackends-velox</span> <span class="nt">-Prss</span> <span class="nt">-pl</span> backends-velox <span class="nt">-am</span> <span class="se">\</span>
<span class="nt">-DtagsToInclude</span><span class="o">=</span><span class="s2">"io.glutenproject.tags.GenerateExample"</span> <span class="nt">-Dtest</span><span class="o">=</span>none <span class="nt">-DfailIfNoTests</span><span class="o">=</span><span class="nb">false</span> <span class="nt">-Darrow</span>.version<span class="o">=</span>11.0.0-gluten <span class="nt">-Dexec</span>.skip
</code></pre></div></div> <p>The generated example files are placed in gluten/backends-velox:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tree gluten/backends-velox/generated-native-benchmark/
gluten/backends-velox/generated-native-benchmark/
├── example.json
├── example_lineitem
│   ├── part-00000-3ec19189-d20e-4240-85ae-88631d46b612-c000.snappy.parquet
│   └── _SUCCESS
└── example_orders
    ├── part-00000-1e66fb98-4dd6-47a6-8679-8625dbc437ee-c000.snappy.parquet
    └── _SUCCESS
</code></pre></div></div> <p>Run micro benchmark with the generated files as input. You need to specify the <strong>absolute</strong> path to the input files:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /path/to/gluten/cpp/build/velox/benchmarks
./generic_benchmark <span class="se">\</span>
<span class="nt">--plan</span> /home/sparkuser/github/oap-project/gluten/backends-velox/generated-native-benchmark/example.json <span class="se">\</span>
<span class="nt">--data</span> /home/sparkuser/github/oap-project/gluten/backends-velox/generated-native-benchmark/example_orders/part-00000-1e66fb98-4dd6-47a6-8679-8625dbc437ee-c000.snappy.parquet,<span class="se">\</span>
/home/sparkuser/github/oap-project/gluten/backends-velox/generated-native-benchmark/example_lineitem/part-00000-3ec19189-d20e-4240-85ae-88631d46b612-c000.snappy.parquet <span class="se">\</span>
<span class="nt">--threads</span> 1 <span class="nt">--iterations</span> 1 <span class="nt">--noprint-result</span> <span class="nt">--benchmark_filter</span><span class="o">=</span>InputFromBatchStream
</code></pre></div></div> <p>The output should be like:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2022-11-18T16:49:56+08:00
Running ./generic_benchmark
Run on <span class="o">(</span>192 X 3800 MHz CPU s<span class="o">)</span>
CPU Caches:
  L1 Data 48 KiB <span class="o">(</span>x96<span class="o">)</span>
  L1 Instruction 32 KiB <span class="o">(</span>x96<span class="o">)</span>
  L2 Unified 2048 KiB <span class="o">(</span>x96<span class="o">)</span>
  L3 Unified 99840 KiB <span class="o">(</span>x2<span class="o">)</span>
Load Average: 0.28, 1.17, 1.59
<span class="k">***</span>WARNING<span class="k">***</span> CPU scaling is enabled, the benchmark real <span class="nb">time </span>measurements may be noisy and will incur extra overhead.
<span class="nt">--</span> Project[expressions: <span class="o">(</span>n3_0:BIGINT, ROW[<span class="s2">"n1_0"</span><span class="o">])</span>, <span class="o">(</span>n3_1:VARCHAR, ROW[<span class="s2">"n1_1"</span><span class="o">])]</span> -&gt; n3_0:BIGINT, n3_1:VARCHAR
   Output: 535 rows <span class="o">(</span>65.81KB, 1 batches<span class="o">)</span>, Cpu <span class="nb">time</span>: 36.33us, Blocked wall <span class="nb">time</span>: 0ns, Peak memory: 1.00MB, Memory allocations: 3, Threads: 1
      queuedWallNanos    <span class="nb">sum</span>: 2.00us, count: 2, min: 0ns, max: 2.00us
  <span class="nt">--</span> HashJoin[RIGHT SEMI <span class="o">(</span>FILTER<span class="o">)</span> <span class="nv">n0_0</span><span class="o">=</span>n1_0] -&gt; n1_0:BIGINT, n1_1:VARCHAR
     Output: 535 rows <span class="o">(</span>65.81KB, 1 batches<span class="o">)</span>, Cpu <span class="nb">time</span>: 191.56us, Blocked wall <span class="nb">time</span>: 0ns, Peak memory: 2.00MB, Memory allocations: 8
     HashBuild: Input: 582 rows <span class="o">(</span>16.45KB, 1 batches<span class="o">)</span>, Output: 0 rows <span class="o">(</span>0B, 0 batches<span class="o">)</span>, Cpu <span class="nb">time</span>: 1.84us, Blocked wall <span class="nb">time</span>: 0ns, Peak memory: 1.00MB, Memory allocations: 3, Threads: 1
        distinctKey0       <span class="nb">sum</span>: 583, count: 1, min: 583, max: 583
        queuedWallNanos    <span class="nb">sum</span>: 0ns, count: 1, min: 0ns, max: 0ns
        rangeKey0          <span class="nb">sum</span>: 59748, count: 1, min: 59748, max: 59748
     HashProbe: Input: 37897 rows <span class="o">(</span>296.07KB, 1 batches<span class="o">)</span>, Output: 535 rows <span class="o">(</span>65.81KB, 1 batches<span class="o">)</span>, Cpu <span class="nb">time</span>: 189.71us, Blocked wall <span class="nb">time</span>: 0ns, Peak memory: 1.00MB, Memory allocations: 5, Threads: 1
        queuedWallNanos    <span class="nb">sum</span>: 0ns, count: 1, min: 0ns, max: 0ns
    <span class="nt">--</span> ArrowStream[] -&gt; n0_0:BIGINT
       Input: 0 rows <span class="o">(</span>0B, 0 batches<span class="o">)</span>, Output: 37897 rows <span class="o">(</span>296.07KB, 1 batches<span class="o">)</span>, Cpu <span class="nb">time</span>: 1.29ms, Blocked wall <span class="nb">time</span>: 0ns, Peak memory: 0B, Memory allocations: 0, Threads: 1
    <span class="nt">--</span> ArrowStream[] -&gt; n1_0:BIGINT, n1_1:VARCHAR
       Input: 0 rows <span class="o">(</span>0B, 0 batches<span class="o">)</span>, Output: 582 rows <span class="o">(</span>16.45KB, 1 batches<span class="o">)</span>, Cpu <span class="nb">time</span>: 894.22us, Blocked wall <span class="nb">time</span>: 0ns, Peak memory: 0B, Memory allocations: 0, Threads: 1

<span class="nt">-----------------------------------------------------------------------------------------------------------------------------</span>
Benchmark                                                                   Time             CPU   Iterations UserCounters...
<span class="nt">-----------------------------------------------------------------------------------------------------------------------------</span>
InputFromBatchVector/iterations:1/process_time/real_time/threads:1   41304520 ns     23740340 ns            1 <span class="nv">collect_batch_time</span><span class="o">=</span>34.7812M <span class="nv">elapsed_time</span><span class="o">=</span>41.3113M

</code></pre></div></div> <h2 id="generate-substrait-plan-and-input-for-any-query"> <a href="#generate-substrait-plan-and-input-for-any-query" class="anchor-heading" aria-labelledby="generate-substrait-plan-and-input-for-any-query"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Generate Substrait plan and input for any query </h2> <p>First, build Gluten with <code class="language-plaintext highlighter-rouge">--build_benchmarks=ON</code>.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /path/to/gluten/
./dev/buildbundle-veloxbe.sh <span class="nt">--build_benchmarks</span><span class="o">=</span>ON

<span class="c"># For debugging purpose, rebuild Gluten with build type `Debug`.</span>
./dev/buildbundle-veloxbe.sh <span class="nt">--build_benchmarks</span><span class="o">=</span>ON <span class="nt">--build_type</span><span class="o">=</span>Debug
</code></pre></div></div> <p>First, get the Stage Id from spark UI for the stage you want to simulate. And then re-run the query with below configurations to dump the inputs to micro benchmark.</p> <div class="table-wrapper"><table> <thead> <tr> <th>Parameters</th> <th>Description</th> <th>Recommend Setting</th> </tr> </thead> <tbody> <tr> <td>spark.gluten.sql.benchmark_task.stageId</td> <td>Spark task stage id</td> <td>target stage id</td> </tr> <tr> <td>spark.gluten.sql.benchmark_task.partitionId</td> <td>Spark task partition id, default value -1 means all the partition of this stage</td> <td>0</td> </tr> <tr> <td>spark.gluten.sql.benchmark_task.taskId</td> <td>If not specify partition id, use spark task attempt id, default value -1 means all the partition of this stage</td> <td>target task attemp id</td> </tr> <tr> <td>spark.gluten.saveDir</td> <td>Directory to save the inputs to micro benchmark, should exist and be empty.</td> <td>/path/to/saveDir</td> </tr> </tbody> </table></div> <p>Check the files in <code class="language-plaintext highlighter-rouge">spark.gluten.saveDir</code>. If the simulated stage is a first stage, you will get 3 types of dumped file:</p> <ul> <li>Configuration file: INI formatted, file name <code class="language-plaintext highlighter-rouge">conf_[stageId]_[partitionId].ini</code>. Contains the configurations to init Velox backend and runtime session.</li> <li>Plan file: JSON formatted, file name <code class="language-plaintext highlighter-rouge">plan_[stageId]_[partitionId].json</code>. Contains the substrait plan to the stage, without input file splits.</li> <li>Split file: JSON formatted, file name <code class="language-plaintext highlighter-rouge">split_[stageId]_[partitionId]_[splitIndex].json</code>. There can be more than one split file in a first stage task. Contains the substrait plan piece to the input file splits.</li> </ul> <p>Run benchmark. By default, the result will be printed to stdout. You can use <code class="language-plaintext highlighter-rouge">--noprint-result</code> to suppress this output.</p> <p>Sample command:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /path/to/gluten/cpp/build/velox/benchmarks
./generic_benchmark <span class="se">\</span>
<span class="nt">--conf</span> /absolute_path/to/conf_[stageId]_[partitionId].ini <span class="se">\</span>
<span class="nt">--plan</span> /absolute_path/to/plan_[stageId]_[partitionId].json <span class="se">\</span>
<span class="nt">--split</span> /absolut_path/to/split_[stageId]_[partitionId]_0.parquet,/absolut_path/to/split_[stageId]_[partitionId]_1.parquet <span class="se">\</span>
<span class="nt">--threads</span> 1 <span class="nt">--noprint-result</span>
</code></pre></div></div> <p>If the simulated stage is a middle stage, you will get 3 types of dumped file:</p> <ul> <li>Configuration file: INI formatted, file name <code class="language-plaintext highlighter-rouge">conf_[stageId]_[partitionId].ini</code>. Contains the configurations to init Velox backend and runtime session.</li> <li>Plan file: JSON formatted, file name <code class="language-plaintext highlighter-rouge">plan_[stageId]_[partitionId].json</code>. Contains the substrait plan to the stage.</li> <li>Data file: Parquet formatted, file name <code class="language-plaintext highlighter-rouge">data_[stageId]_[partitionId]_[iteratorIndex].json</code>. There can be more than one input data file in a middle stage task. The input data files of a middle stage will be loaded as iterators to serve as the inputs for the pipeline:</li> </ul> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"localFiles"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
</span><span class="p">{</span><span class="w">
</span><span class="nl">"uriFile"</span><span class="p">:</span><span class="w"> </span><span class="s2">"iterator:0"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>Sample command:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /path/to/gluten/cpp/build/velox/benchmarks
./generic_benchmark <span class="se">\</span>
<span class="nt">--conf</span> /absolute_path/to/conf_[stageId]_[partitionId].ini <span class="se">\</span>
<span class="nt">--plan</span> /absolute_path/to/plan_[stageId]_[partitionId].json <span class="se">\</span>
<span class="nt">--data</span> /absolut_path/to/data_[stageId]_[partitionId]_0.parquet,/absolut_path/to/data_[stageId]_[partitionId]_1.parquet <span class="se">\</span>
<span class="nt">--threads</span> 1 <span class="nt">--noprint-result</span>
</code></pre></div></div> <p>For some complex queries, stageId may cannot represent the Substrait plan input, please get the taskId from spark UI, and get your target parquet from saveDir.</p> <p>In this example, only one partition input with partition id 2, taskId is 36, iterator length is 2.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /path/to/gluten/cpp/build/velox/benchmarks
./generic_benchmark <span class="se">\</span>
<span class="nt">--plan</span> /absolute_path/to/complex_plan.json <span class="se">\</span>
<span class="nt">--data</span> /absolute_path/to/data_36_2_0.parquet,/absolute_path/to/data_36_2_1.parquet <span class="se">\</span>
<span class="nt">--threads</span> 1 <span class="nt">--noprint-result</span>
</code></pre></div></div> <h2 id="save-ouput-to-parquet-to-analyze"> <a href="#save-ouput-to-parquet-to-analyze" class="anchor-heading" aria-labelledby="save-ouput-to-parquet-to-analyze"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Save ouput to parquet to analyze </h2> <p>You can save the output to a parquet file to analyze.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /path/to/gluten/cpp/build/velox/benchmarks
./generic_benchmark <span class="se">\</span>
<span class="nt">--plan</span> /absolute_path/to/plan.json <span class="se">\</span>
<span class="nt">--data</span> /absolute_path/to/data.parquet
<span class="nt">--threads</span> 1 <span class="nt">--noprint-result</span> <span class="nt">--write-file</span><span class="o">=</span>/absolute_path/to/result.parquet
</code></pre></div></div> <h2 id="add-shuffle-write-process"> <a href="#add-shuffle-write-process" class="anchor-heading" aria-labelledby="add-shuffle-write-process"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Add shuffle write process </h2> <p>You can add the shuffle write process at the end of this stage. Note that this will ignore the <code class="language-plaintext highlighter-rouge">--write-file</code> option.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /path/to/gluten/cpp/build/velox/benchmarks
./generic_benchmark <span class="se">\</span>
<span class="nt">--plan</span> /absolute_path/to/plan.json <span class="se">\</span>
<span class="nt">--split</span> /absolute_path/to/split.json <span class="se">\</span>
<span class="nt">--threads</span> 1 <span class="nt">--noprint-result</span> <span class="nt">--with-shuffle</span>
</code></pre></div></div> <p>By default, the compression codec for shuffle outputs is LZ4. You can switch to other codecs by adding one of the following argument flags to the command:</p> <ul> <li>–zstd: ZSTD codec, compression level 1</li> <li>–qat-gzip: QAT GZIP codec, compression level 1</li> <li>–qat-zstd: QAT ZSTD codec, compression level 1</li> <li>–iaa-gzip: IAA GZIP codec, compression level 1</li> </ul> <p>Note using QAT or IAA codec requires Gluten cpp is built with these features. Please check the corresponding section in <a href="http://gluten.apache.org/docs/getting-started/velox-backend/">Velox document</a> first for how to setup, build and enable these features in Gluten. For QAT support, please check <a href="http://gluten.apache.org/docs/getting-started/velox-backend/#intel-quickassist-technology-qat-support">Intel® QuickAssist Technology (QAT) support</a>. For IAA support, please check <a href="http://gluten.apache.org/docs/getting-started/velox-backend/#intel-in-memory-analytics-accelerator-iaaiax-support">Intel® In-memory Analytics Accelerator (IAA/IAX) support</a></p> <h2 id="simulate-spark-with-multiple-processes-and-threads"> <a href="#simulate-spark-with-multiple-processes-and-threads" class="anchor-heading" aria-labelledby="simulate-spark-with-multiple-processes-and-threads"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Simulate Spark with multiple processes and threads </h2> <p>You can use below command to launch several processes and threads to simulate parallel execution on Spark. Each thread in the same process will be pinned to the core number starting from <code class="language-plaintext highlighter-rouge">--cpu</code>.</p> <p>Suppose running on a baremetal machine with 48C, 2-socket, HT-on, launching below command will utilize all vcores.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">processes</span><span class="o">=</span>24 <span class="c"># Same value of spark.executor.instances</span>
<span class="nv">threads</span><span class="o">=</span>8 <span class="c"># Same value of spark.executor.cores</span>

<span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt;<span class="k">${</span><span class="nv">processes</span><span class="k">}</span><span class="p">;</span> i++<span class="o">))</span><span class="p">;</span> <span class="k">do</span>
    ./generic_benchmark <span class="nt">--plan</span> /path/to/plan.json <span class="nt">--split</span> /path/to/split.json <span class="nt">--noprint-result</span> <span class="nt">--threads</span> <span class="nv">$threads</span> <span class="nt">--cpu</span> <span class="k">$((</span>i<span class="o">*</span>threads<span class="k">))</span> &amp;
<span class="k">done</span>
</code></pre></div></div> <p>If you want to add the shuffle write process, you can specify multiple direcotries by setting environment variable <code class="language-plaintext highlighter-rouge">GLUTEN_SPARK_LOCAL_DIRS</code> to a comma-separated string for shuffle write to spread the I/O pressure to multiple disks.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> <span class="o">{</span>/data1,/data2,/data3<span class="o">}</span>/tmp <span class="c"># Make sure each directory has been already created.</span>
<span class="nb">export </span><span class="nv">GLUTEN_SPARK_LOCAL_DIRS</span><span class="o">=</span>/data1/tmp,/data2/tmp,/data3/tmp

<span class="nv">processes</span><span class="o">=</span>24 <span class="c"># Same value of spark.executor.instances</span>
<span class="nv">threads</span><span class="o">=</span>8 <span class="c"># Same value of spark.executor.cores</span>

<span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt;<span class="k">${</span><span class="nv">processes</span><span class="k">}</span><span class="p">;</span> i++<span class="o">))</span><span class="p">;</span> <span class="k">do</span>
    ./generic_benchmark <span class="nt">--plan</span> /path/to/plan.json <span class="nt">--split</span> /path/to/split.json <span class="nt">--noprint-result</span> <span class="nt">--with-shuffle</span> <span class="nt">--threads</span> <span class="nv">$threads</span> <span class="nt">--cpu</span> <span class="k">$((</span>i<span class="o">*</span>threads<span class="k">))</span> &amp;
<span class="k">done</span>
</code></pre></div></div> <h3 id="run-examples"> <a href="#run-examples" class="anchor-heading" aria-labelledby="run-examples"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Run Examples </h3> <p>We also provide some example inputs in <a href="https://github.com/apache/incubator-gluten/tree/main/cpp/velox/benchmarks/data">cpp/velox/benchmarks/data</a>. E.g. <a href="https://github.com/apache/incubator-gluten/tree/main/cpp/velox/benchmarks/data/generic_q5/q5_first_stage_0.json">generic_q5/q5_first_stage_0.json</a> simulates a first-stage in TPCH Q5, which has the the most heaviest table scan. You can follow below steps to run this example.</p> <ol> <li>Open <a href="https://github.com/apache/incubator-gluten/tree/main/cpp/velox/benchmarks/data/generic_q5/q5_first_stage_0_split.json">generic_q5/q5_first_stage_0.json</a> with file editor. Search for <code class="language-plaintext highlighter-rouge">"uriFile": "LINEITEM"</code> and replace <code class="language-plaintext highlighter-rouge">LINEITEM</code> with the URI to one partition file in lineitem. In the next line, replace the number in <code class="language-plaintext highlighter-rouge">"length": "..."</code> with the actual file length. Suppose you are using the provided small TPCH table in <a href="https://github.com/apache/incubator-gluten/tree/main/cpp/velox/benchmarks/data/tpch_sf10m">cpp/velox/benchmarks/data/tpch_sf10m</a>, the replaced JSON should be like:</li> </ol> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"uriFile"</span><span class="p">:</span><span class="w"> </span><span class="s2">"file:///path/to/gluten/cpp/velox/benchmarks/data/tpch_sf10m/lineitem/part-00000-6c374e0a-7d76-401b-8458-a8e31f8ab704-c000.snappy.parquet"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"length"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1863237"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"parquet"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <ol> <li>Launch multiple processes and multiple threads. Set <code class="language-plaintext highlighter-rouge">GLUTEN_SPARK_LOCAL_DIRS</code> and add –with-shuffle to the command.</li> </ol> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> <span class="o">{</span>/data1,/data2,/data3<span class="o">}</span>/tmp <span class="c"># Make sure each directory has been already created.</span>
<span class="nb">export </span><span class="nv">GLUTEN_SPARK_LOCAL_DIRS</span><span class="o">=</span>/data1/tmp,/data2/tmp,/data3/tmp

<span class="nv">processes</span><span class="o">=</span>24 <span class="c"># Same value of spark.executor.instances</span>
<span class="nv">threads</span><span class="o">=</span>8 <span class="c"># Same value of spark.executor.cores</span>

<span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt;<span class="k">${</span><span class="nv">processes</span><span class="k">}</span><span class="p">;</span> i++<span class="o">))</span><span class="p">;</span> <span class="k">do</span>
    ./generic_benchmark <span class="nt">--plan</span> /path/to/gluten/cpp/velox/benchmarks/data/generic_q5/q5_first_stage_0.json <span class="nt">--split</span> /path/to/gluten/cpp/velox/benchmarks/data/generic_q5/q5_first_stage_0_split.json <span class="nt">--noprint-result</span> <span class="nt">--with-shuffle</span> <span class="nt">--threads</span> <span class="nv">$threads</span> <span class="nt">--cpu</span> <span class="k">$((</span>i<span class="o">*</span>threads<span class="k">))</span> &amp;
<span class="k">done</span> <span class="o">&gt;</span>stdout.log 2&gt;stderr.log
</code></pre></div></div> <p>You can find the “elapsed_time” and other metrics in stdout.log. In below output, the “elapsed_time” is ~10.75s. If you run TPCH Q5 with Gluten on Spark, a single task in the same Spark stage should take about the same time.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">------------------------------------------------------------------------------------------------------------------</span>
Benchmark                                                        Time             CPU   Iterations UserCounters...
<span class="nt">------------------------------------------------------------------------------------------------------------------</span>
SkipInput/iterations:1/process_time/real_time/threads:8 1317255379 ns   10061941861 ns            8 <span class="nv">collect_batch_time</span><span class="o">=</span>0 <span class="nv">elapsed_time</span><span class="o">=</span>10.7563G <span class="nv">shuffle_compress_time</span><span class="o">=</span>4.19964G <span class="nv">shuffle_spill_time</span><span class="o">=</span>0 <span class="nv">shuffle_split_time</span><span class="o">=</span>0 <span class="nv">shuffle_write_time</span><span class="o">=</span>1.91651G
</code></pre></div></div> <p><img src="/assets/images/TPCH-q5-first-stage.png" alt="TPCH-Q5-first-stage" /></p> </main> <hr> <footer> <p><a href="#top" id="back-to-top">Back to top</a></p> <a href="https://incubator.apache.org/"><img src="/assets/images/apache-incubator.svg" style="width:300px"></a> <p class="text-small text-grey-dk-100 mb-0">Copyright © 2024 The Apache Software Foundation, Licensed under the Apache License, Version 2.0. Apache Gluten, Gluten, Apache, the Apache feather logo, and the Apache Gluten project logo are either registered trademarks or trademarks of the Apache Software Foundation in the United States and/or other countries.</p> <p class="text-small text-grey-dk-100 mb-0">Apache Gluten is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</p> <p class="text-small text-grey-dk-100 mb-0"><a href="https://privacy.apache.org/policies/privacy-policy-public.html">Privacy Policy</a></p> <div class="d-flex mt-2"> </div> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
