<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav ul li a { background-image: none; } </style> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Apache Gluten incubating | Gluten is a middle layer responsible for offloading JVM-based SQL engines’ execution to native engines.</title> <meta name="generator" content="Jekyll v3.9.3" /> <meta property="og:title" content="Apache Gluten incubating" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Gluten is a middle layer responsible for offloading JVM-based SQL engines’ execution to native engines." /> <meta property="og:description" content="Gluten is a middle layer responsible for offloading JVM-based SQL engines’ execution to native engines." /> <link rel="canonical" href="https://gluten.apache.org/developers/UsingJemallocWithCH.html" /> <meta property="og:url" content="https://gluten.apache.org/developers/UsingJemallocWithCH.html" /> <meta property="og:site_name" content="Apache Gluten incubating" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Apache Gluten incubating" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Gluten is a middle layer responsible for offloading JVM-based SQL engines’ execution to native engines.","headline":"Apache Gluten incubating","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://gluten.apache.org/images/gluten-logo-blue.png"}},"url":"https://gluten.apache.org/developers/UsingJemallocWithCH.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"> <div class="site-logo" role="img" aria-label="Apache Gluten incubating"></div> </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Documentation category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/" class="nav-list-link">Documentation</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Velox Backend category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/velox/" class="nav-list-link">Velox Backend</a><ul class="nav-list"><li class="nav-list-item"> <a href="/docs/velox/getting-started" class="nav-list-link">Getting-Started with Velox Backend</a> </li><li class="nav-list-item"> <a href="/docs/velox/build_parameters" class="nav-list-link">Build Parameters for Velox Backend</a> </li><li class="nav-list-item"> <a href="/docs/velox/s3" class="nav-list-link">Using S3 with Gluten</a> </li><li class="nav-list-item"> <a href="/docs/velox/gcs" class="nav-list-link">Using GCS with Gluten</a> </li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in ClickHouse Backend category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/clickhouse/" class="nav-list-link">ClickHouse Backend</a><ul class="nav-list"><li class="nav-list-item"> <a href="/docs/clickhouse/getting-started" class="nav-list-link">Getting Started with ClickHouse Backend</a> </li></ul></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Developers category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/developers/" class="nav-list-link">Developers</a><ul class="nav-list"><li class="nav-list-item"><a href="/developers/NewToGluten.html" class="nav-list-link">New To Gluten</a></li><li class="nav-list-item"><a href="/developers/HowTo.html" class="nav-list-link">How To Use Gluten</a></li><li class="nav-list-item"><a href="/developers/MicroBenchmarks.html" class="nav-list-link">Micro Benchmarks for Velox Backend</a></li><li class="nav-list-item"><a href="/developers/CppCodingStyle.html" class="nav-list-link">CPP Code Style</a></li><li class="nav-list-item"><a href="/developers/velox-function-development-guide.html" class="nav-list-link">Velox Function Development</a></li><li class="nav-list-item"><a href="/developers/docker_ubuntu22.04.html" class="nav-list-link">Docker script for Ubuntu 22.04/20.04</a></li><li class="nav-list-item"><a href="/developers/docker_centos8.html" class="nav-list-link">Docker script for CentOS 8</a></li><li class="nav-list-item"><a href="/developers/docker_centos7.html" class="nav-list-link">Docker script for CentOS 7</a></li><li class="nav-list-item"><a href="/developers/SubstraitModifications.html" class="nav-list-link">Substrait Modifications</a></li><li class="nav-list-item"><a href="/developers/HowToRelease.html" class="nav-list-link">How To Release</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Archives category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/" class="nav-list-link">Archives</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in v1.1.1 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.1.1/" class="nav-list-link">v1.1.1</a><ul class="nav-list"><li class="nav-list-item"> <a href="/archives/v1.1.1/docs/" class="nav-list-link">v1.1.1/Documentation</a> </li><li class="nav-list-item"> <a href="/archives/v1.1.1/developers/" class="nav-list-link">v1.1.1/Developers</a> </li></ul></li></ul></li><li class="nav-list-item"><a href="/release.html" class="nav-list-link">Gluten Release</a></li><li class="nav-list-item"><a href="/contributing.html" class="nav-list-link">Contributing to Gluten</a></li><li class="nav-list-item"><a href="/asf/" class="nav-list-link">Apache Software Foundation</a></li><li class="nav-list-item"><a href="/contact-us.html" class="nav-list-link">Contact Us</a></li><li class="nav-list-item"><a href="/about/" class="nav-list-link">About</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Apache Gluten incubating" aria-label="Search Apache Gluten incubating" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//github.com/apache/incubator-gluten" class="site-button" > Apache Gluten Github </a> </li> </ul> </nav> </div> <div class="main-content-wrap"> <div id="main-content" class="main-content"> <main> <p>We need using jemalloc to find the memory issue. That’s what this document is about.</p> <h2 id="change-code-of-jemalloc"> <a href="#change-code-of-jemalloc" class="anchor-heading" aria-labelledby="change-code-of-jemalloc"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Change code of jemalloc </h2> <p>Use libunwind instead of libgcc to get the backtrace which may cause process hangs.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@@ -177,7 +177,8 @@ target_compile_definitions(_jemalloc PRIVATE -DJEMALLOC_PROF=1)
 # At the time ClickHouse uses LLVM libunwind which follows libgcc's way of backtracking.
 #
 # ClickHouse has to provide `unw_backtrace` method by the means of [commit 8e2b31e](https://github.com/ClickHouse/libunwind/commit/8e2b31e766dd502f6df74909e04a7dbdf5182eb1).
-target_compile_definitions (_jemalloc PRIVATE -DJEMALLOC_PROF_LIBGCC=1)
+#target_compile_definitions (_jemalloc PRIVATE -DJEMALLOC_PROF_LIBGCC=1)
+target_compile_definitions (_jemalloc PRIVATE -DJEMALLOC_PROF_LIBUNWIND=1)
 target_link_libraries (_jemalloc PRIVATE unwind)
</code></pre></div></div> <p>For more infomation, check https://github.com/jemalloc/jemalloc/issues/2282.</p> <h2 id="get-jeprof"> <a href="#get-jeprof" class="anchor-heading" aria-labelledby="get-jeprof"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Get jeprof </h2> <p>Change to the directory where you want to install jemalloc, and run the following commands:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd $Clickhouse_SOURCE_PATH/contrib/jemalloc &amp;&amp; ./autogen.sh &amp;&amp; ./configure.sh &amp;&amp; make -j8
</code></pre></div></div> <p>Then we get jeprof in the directory <code class="language-plaintext highlighter-rouge">$Clickhouse_SOURCE_PATH/contrib/jemalloc/bin/jeprof</code>.</p> <h2 id="compiler-libchso"> <a href="#compiler-libchso" class="anchor-heading" aria-labelledby="compiler-libchso"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Compiler libch.so </h2> <p>Ensure to enable jemalloc <code class="language-plaintext highlighter-rouge">-DENABLE_JEMALLOC=ON</code> in cpp-ch/CMakeLists.txt, and compile libch.so.</p> <h2 id="run-gluten-with-jemalloc-heap-tools"> <a href="#run-gluten-with-jemalloc-heap-tools" class="anchor-heading" aria-labelledby="run-gluten-with-jemalloc-heap-tools"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Run Gluten with jemalloc heap tools </h2> <p>For Yarn or thrift server, you need add the following to the submit script:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export MALLOC_CONF="prof:true,lg_prof_interval:30" # enable jemalloc heap profiling
</code></pre></div></div> <p>You can find more options in https://github.com/jemalloc/jemalloc/wiki/Use-Case%3A-Heap-Profiling.</p> <h2 id="analyze-the-result"> <a href="#analyze-the-result" class="anchor-heading" aria-labelledby="analyze-the-result"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Analyze the result </h2> <p>After you get the heap file, you can use the following command to analyze the result: Check memory diff, so you can find which part of the code consume the memory.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jeprof --svg /usr/lib/jvm/java-8-openjdk-amd64/bin/java --base=jeprof.3717358.1.i1.heap jeprof.3717358.30.i30.heap &gt; diff.svg
</code></pre></div></div> <p>You can find more usage about jeprof with <code class="language-plaintext highlighter-rouge">jeprof --help</code>.</p> </main> <hr> <footer> <p><a href="#top" id="back-to-top">Back to top</a></p> <a href="https://incubator.apache.org/">Apache Incubator</a> <p class="text-small text-grey-dk-100 mb-0">Copyright © 2024 The Apache Software Foundation, Licensed under the Apache License, Version 2.0. Apache Gluten, Gluten, Apache, the Apache feather logo, and the Apache Gluten project logo are either registered trademarks or trademarks of the Apache Software Foundation in the United States and/or other countries.</p> <p class="text-small text-grey-dk-100 mb-0">Apache Gluten is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</p> <p class="text-small text-grey-dk-100 mb-0"><a href="https://privacy.apache.org/policies/privacy-policy-public.html">Privacy Policy</a></p> <div class="d-flex mt-2"> </div> </footer> </div> </div> <div class="search-overlay"></div> </div> <script type="module"> import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10.8.0/dist/mermaid.esm.min.mjs'; var config = {} ; mermaid.initialize(config); mermaid.run({ querySelector: '.language-mermaid', }); </script> </body> </html>
