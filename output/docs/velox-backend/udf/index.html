<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li > a, .site-nav > ul.nav-list:first-child > li > ul > li > a, .site-nav > ul.nav-list:first-child > li > ul > li > ul > li:not(:nth-child(4)) > a, .site-nav > ul.nav-list:first-child > li > ul > li > ul > li > ul > li a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(2) > ul > li:nth-child(4) > ul > li:nth-child(4) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(2) > button svg, .site-nav > ul.nav-list:first-child > li:nth-child(2) > ul > li:nth-child(4) > button svg, .site-nav > ul.nav-list:first-child > li:nth-child(2) > ul > li:nth-child(4) > ul > li:nth-child(4) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(2) > ul.nav-list, .site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(2) > ul.nav-list > li.nav-list-item:nth-child(4) > ul.nav-list, .site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(2) > ul.nav-list > li.nav-list-item:nth-child(4) > ul.nav-list > li.nav-list-item:nth-child(4) > ul.nav-list { display: block; } </style> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Velox UDF | Apache Gluten incubating</title> <meta name="generator" content="Jekyll v3.9.3" /> <meta property="og:title" content="Velox UDF" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Gluten is a middle layer responsible for offloading JVM-based SQL engines’ execution to native engines." /> <meta property="og:description" content="Gluten is a middle layer responsible for offloading JVM-based SQL engines’ execution to native engines." /> <link rel="canonical" href="https://gluten.apache.org/docs/velox-backend/udf/" /> <meta property="og:url" content="https://gluten.apache.org/docs/velox-backend/udf/" /> <meta property="og:site_name" content="Apache Gluten incubating" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Velox UDF" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Gluten is a middle layer responsible for offloading JVM-based SQL engines’ execution to native engines.","headline":"Velox UDF","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://gluten.apache.org/assets/images/gluten-logo-blue.png"}},"url":"https://gluten.apache.org/docs/velox-backend/udf/"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"> <div class="site-logo" role="img" aria-label="Apache Gluten incubating"></div> </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Documentations category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/" class="nav-list-link">Documentations</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Getting-Started category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/getting-started/" class="nav-list-link">Getting-Started</a><ul class="nav-list"><li class="nav-list-item"><a href="/docs/getting-started/velox-backend/" class="nav-list-link">Getting Start with Velox Backend</a></li><li class="nav-list-item"><a href="/docs/getting-started/clickhouse-backend/" class="nav-list-link">Getting start with ClickHouse Backend</a></li><li class="nav-list-item"><a href="/docs/getting-started/build-guide/" class="nav-list-link">Build Parameters for Velox Backend</a></li><li class="nav-list-item"><a href="/docs/getting-started/s3/" class="nav-list-link">Using S3 with Gluten</a></li><li class="nav-list-item"><a href="/docs/getting-started/gcs/" class="nav-list-link">Using GCS with Gluten</a></li><li class="nav-list-item"><a href="/docs/getting-started/abfs/" class="nav-list-link">Using ABFS with Gluten</a></li><li class="nav-list-item"><a href="/docs/getting-started/localcache/" class="nav-list-link">Velox Local Caching</a></li></ul></li><li class="nav-list-item"><a href="/docs/configuration/" class="nav-list-link">Configuration</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Developers category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/developers/" class="nav-list-link">Developers</a><ul class="nav-list"><li class="nav-list-item"><a href="/docs/developers/how-to-use/" class="nav-list-link">How To Use Gluten</a></li><li class="nav-list-item"><a href="/docs/developers/new-to/" class="nav-list-link">New To Gluten</a></li><li class="nav-list-item"><a href="/docs/developers/microbenchmarks/" class="nav-list-link">Micro Benchmarks for Velox Backend</a></li><li class="nav-list-item"><a href="/docs/developers/cpp-code-style/" class="nav-list-link">CPP Code Style</a></li><li class="nav-list-item"><a href="/docs/developers/velox-function-dev/" class="nav-list-link">Velox Function Development</a></li><li class="nav-list-item"><a href="/docs/developers/docker-ubuntu/" class="nav-list-link">Docker script for Ubuntu 22.04/20.04</a></li><li class="nav-list-item"><a href="/docs/developers/docker-centos7/" class="nav-list-link">Docker script for CentOS 7</a></li><li class="nav-list-item"><a href="/docs/developers/docker-centos8/" class="nav-list-link">Docker script for CentOS 8</a></li><li class="nav-list-item"><a href="/docs/developers/substrait/" class="nav-list-link">Substrait Modifications</a></li><li class="nav-list-item"><a href="/docs/developers/how-to-release/" class="nav-list-link">How To Release</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Velox Backend category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/velox-backend/" class="nav-list-link">Velox Backend</a><ul class="nav-list"><li class="nav-list-item"><a href="/docs/velox-backend/support/" class="nav-list-link">Supported Operators & Functions</a></li><li class="nav-list-item"><a href="/docs/velox-backend/limitations/" class="nav-list-link">Limitations</a></li><li class="nav-list-item"><a href="/docs/velox-backend/troubleshooting/" class="nav-list-link">Troubleshooting</a></li><li class="nav-list-item"><a href="/docs/velox-backend/udf/" class="nav-list-link">Velox UDF</a></li></ul></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Archives category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/" class="nav-list-link">Archives</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in v1.1.1 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.1.1/" class="nav-list-link">v1.1.1</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in v1.1.1/Documentation category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.1.1/docs/" class="nav-list-link">v1.1.1/Documentation</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in v1.1.1/Velox Backend category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.1.1/docs/velox/" class="nav-list-link">v1.1.1/Velox Backend</a><ul class="nav-list"><li class="nav-list-item"><a href="/archives/v1.1.1/docs/velox/getting-started/" class="nav-list-link">v1.1.1/Getting-Started with Velox Backend</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/docs/velox/build_parameters/" class="nav-list-link">v1.1.1/Build Parameters for Velox Backend</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/docs/velox/s3/" class="nav-list-link">v1.1.1/Using S3 with Gluten</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/docs/velox/gcs/" class="nav-list-link">v1.1.1/Using GCS with Gluten</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in v1.1.1/ClickHouse Backend category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.1.1/docs/clickhouse/" class="nav-list-link">v1.1.1/ClickHouse Backend</a><ul class="nav-list"><li class="nav-list-item"><a href="/archives/v1.1.1/docs/clickhouse/getting-started/" class="nav-list-link">v1.1.1/Getting Started with ClickHouse Backend</a></li></ul></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in v1.1.1/Developers category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/archives/v1.1.1/developers/" class="nav-list-link">v1.1.1/Developers</a><ul class="nav-list"><li class="nav-list-item"><a href="/archives/v1.1.1/developers/newto/" class="nav-list-link">v1.1.1/New To Gluten</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/howto/" class="nav-list-link">v1.1.1/How To Use Gluten</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/microbenchmark/" class="nav-list-link">v1.1.1/Micro Benchmarks for Velox Backend</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/cpp_code_style/" class="nav-list-link">v1.1.1/CPP Code Style</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/velox_function_development/" class="nav-list-link">v1.1.1/Velox Function Development</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/docker_ubuntu/" class="nav-list-link">v1.1.1/Docker script for Ubuntu 22.04/20.04</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/docker_centos8" class="nav-list-link">v1.1.1/Docker script for CentOS 8</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/docker_centos7/" class="nav-list-link">v1.1.1/Docker script for CentOS 7</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/substrait/" class="nav-list-link">v1.1.1/Substrait Modifications</a></li><li class="nav-list-item"><a href="/archives/v1.1.1/developers/howtorelease/" class="nav-list-link">v1.1.1/How To Release</a></li></ul></li></ul></li></ul></li><li class="nav-list-item"><a href="/downloads/" class="nav-list-link">Downloads</a></li><li class="nav-list-item"><a href="/references/" class="nav-list-link">Gluten References</a></li><li class="nav-list-item"><a href="/contributing/" class="nav-list-link">Contributing to Gluten</a></li><li class="nav-list-item"><a href="/contact/" class="nav-list-link">Contact Us</a></li><li class="nav-list-item"><a href="/about/" class="nav-list-link">About</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Apache Gluten incubating" aria-label="Search Apache Gluten incubating" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <style> /* Style The Dropdown Button */ .dropbtn { background-color: #0000ff80; color: white; padding: 22px; width: 100%; font-size: 14px; border: none; cursor: pointer; } /* The container <div> - needed to position the dropdown content */ .dropdown { position: relative; display: inline-block; } /* Dropdown Content (Hidden by Default) */ .dropdown-content { display: none; position: absolute; background-color: #f9f9f9; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; } /* Links inside the dropdown */ .dropdown-content a { color: black; padding: 12px 14px; text-decoration: none; display: block; } /* Change color of dropdown links on hover */ .dropdown-content a:hover {background-color: #f1f1f1} /* Show the dropdown menu on hover */ .dropdown:hover .dropdown-content { display: block; } /* Change the background color of the dropdown button when the dropdown content is shown */ .dropdown:hover .dropbtn { background-color: #0000ff; } </style> <!-- Collect the nav links, forms, and other content for toggling --> <div class="dropdown" id="apache-navbar" style="float:left;"> <button class="dropbtn">ASF</button> <div class="dropdown-content"> <a class="dropdown-item" href="https://www.apache.org/">Foundation</a> <a class="dropdown-item" href="https://www.apache.org/events/current-event.html">Event</a> <a class="dropdown-item" href="https://www.apache.org/licenses/">License</a> <a class="dropdown-item" href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a> <a class="dropdown-item" href="https://www.apache.org/security/">Security</a> <a class="dropdown-item" href="https://privacy.apache.org/policies/privacy-policy-public.html">Privacy</a> <a class="dropdown-item" href="https://www.apache.org/foundation/thanks.html">Thanks</a> </div> </div><!-- /.navbar-collapse --> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//github.com/apache/incubator-gluten" class="site-button" target="_blank" rel="noopener noreferrer" > Apache Gluten Github </a> </li> </ul> </nav> </div> <div class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/docs/">Documentations</a></li> <li class="breadcrumb-nav-list-item"><a href="/docs/velox-backend/">Velox Backend</a></li> <li class="breadcrumb-nav-list-item"><span>Velox UDF</span></li> </ol> </nav> <div id="main-content" class="main-content"> <main> <h1 id="velox-user-defined-functions-udf-and-user-defined-aggregate-functions-udaf"> <a href="#velox-user-defined-functions-udf-and-user-defined-aggregate-functions-udaf" class="anchor-heading" aria-labelledby="velox-user-defined-functions-udf-and-user-defined-aggregate-functions-udaf"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Velox User-Defined Functions (UDF) and User-Defined Aggregate Functions (UDAF) </h1> <h2 id="introduction"> <a href="#introduction" class="anchor-heading" aria-labelledby="introduction"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Introduction </h2> <p>Velox backend supports User-Defined Functions (UDF) and User-Defined Aggregate Functions (UDAF). Users can create their own functions using the UDF interface provided in Velox backend and build libraries for these functions. At runtime, the UDF are registered at the start of applications. Once registered, Gluten will be able to parse and offload these UDF into Velox during execution.</p> <h2 id="create-and-build-udfudaf-library"> <a href="#create-and-build-udfudaf-library" class="anchor-heading" aria-labelledby="create-and-build-udfudaf-library"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Create and Build UDF/UDAF library </h2> <p>The following steps demonstrate how to set up a UDF library project:</p> <ul> <li> <p><strong>Include the UDF Interface Header:</strong> First, include the UDF interface header file <a href="../../cpp/velox/udf/Udf.h">Udf.h</a> in the project file. The header file defines the <code class="language-plaintext highlighter-rouge">UdfEntry</code> struct, along with the macros for declaring the necessary functions to integrate the UDF into Gluten and Velox.</p> </li> <li> <p><strong>Implement the UDF:</strong> Implement UDF. These functions should be able to register to Velox.</p> </li> <li> <p><strong>Implement the Interface Functions:</strong> Implement the following interface functions that integrate UDF into Project Gluten:</p> <ul> <li> <p><code class="language-plaintext highlighter-rouge">getNumUdf()</code>: This function should return the number of UDF in the library. This is used to allocating udfEntries array as the argument for the next function <code class="language-plaintext highlighter-rouge">getUdfEntries</code>.</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">getUdfEntries(gluten::UdfEntry* udfEntries)</code>: This function should populate the provided udfEntries array with the details of the UDF, including function names and signatures.</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">registerUdf()</code>: This function is called to register the UDF to Velox function registry. This is where users should register functions by calling <code class="language-plaintext highlighter-rouge">facebook::velox::exec::registerVecotorFunction</code> or other Velox APIs.</p> </li> <li> <p>The interface functions are mapped to marcos in <a href="../../cpp/velox/udf/Udf.h">Udf.h</a>. Here’s an example of how to implement these functions:</p> </li> </ul> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Filename MyUDF.cc

#include &lt;velox/expression/VectorFunction.h&gt;
#include &lt;velox/udf/Udf.h&gt;

namespace {
static const char* kInteger = "integer";
}

const int kNumMyUdf = 1;

const char* myUdfArgs[] = {kInteger}:
gluten::UdfEntry myUdfSig = {"myudf", kInteger, 1, myUdfArgs};

class MyUdf : public facebook::velox::exec::VectorFunction {
  ... // Omit concrete implementation
}

static std::vector&lt;std::shared_ptr&lt;exec::FunctionSignature&gt;&gt;
myUdfSignatures() {
  return {facebook::velox::exec::FunctionSignatureBuilder()
              .returnType(myUdfSig.dataType)
              .argumentType(myUdfSig.argTypes[0])
              .build()};
}

DEFINE_GET_NUM_UDF { return kNumMyUdf; }

DEFINE_GET_UDF_ENTRIES { udfEntries[0] = myUdfSig; }

DEFINE_REGISTER_UDF {
  facebook::velox::exec::registerVectorFunction(
      myUdf[0].name, myUdfSignatures(), std::make_unique&lt;MyUdf&gt;());
}

</code></pre></div> </div> </li> </ul> <p>To build the UDF library, users need to compile the C++ code and link to <code class="language-plaintext highlighter-rouge">libvelox.so</code>. It’s recommended to create a CMakeLists.txt for the project. Here’s an example:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>project(myudf)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

set(GLUTEN_HOME /path/to/gluten)

add_library(myudf SHARED "MyUDF.cpp")

find_library(VELOX_LIBRARY REQUIRED NAMES velox HINTS ${GLUTEN_HOME}/cpp/build/releases NO_DEFAULT_PATH)

target_include_directories(myudf PRIVATE ${GLUTEN_HOME}/cpp ${GLUTEN_HOME}/ep/build-velox/build/velox_ep)
target_link_libraries(myudf PRIVATE ${VELOX_LIBRARY})
</code></pre></div></div> <p>The steps for creating and building a UDAF library are quite similar to those for a UDF library. The major difference lies in including and defining specific functions within the UDAF header file <a href="../../cpp/velox/udf/Udaf.h">Udaf.h</a></p> <ul> <li><code class="language-plaintext highlighter-rouge">getNumUdaf()</code></li> <li><code class="language-plaintext highlighter-rouge">getUdafEntries(gluten::UdafEntry* udafEntries)</code></li> <li><code class="language-plaintext highlighter-rouge">registerUdaf()</code></li> </ul> <p><code class="language-plaintext highlighter-rouge">gluten::UdafEntry</code> requires an additional field <code class="language-plaintext highlighter-rouge">intermediateType</code>, to specify the output type from partial aggregation. For detailed implementation, you can refer to the example code in <a href="../../cpp/velox/udf/examples/MyUDAF.cc">MyUDAF.cc</a></p> <h2 id="using-udfudaf-in-gluten"> <a href="#using-udfudaf-in-gluten" class="anchor-heading" aria-labelledby="using-udfudaf-in-gluten"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Using UDF/UDAF in Gluten </h2> <p>Gluten loads the UDF libraries at runtime. You can upload UDF libraries via <code class="language-plaintext highlighter-rouge">--files</code> or <code class="language-plaintext highlighter-rouge">--archives</code>, and configure the library paths using the provided Spark configuration, which accepts comma separated list of library paths.</p> <p>Note if running on Yarn client mode, the uploaded files are not reachable on driver side. Users should copy those files to somewhere reachable for driver and set <code class="language-plaintext highlighter-rouge">spark.gluten.sql.columnar.backend.velox.driver.udfLibraryPaths</code>. This configuration is also useful when the <code class="language-plaintext highlighter-rouge">udfLibraryPaths</code> is different between driver side and executor side.</p> <ul> <li>Use the <code class="language-plaintext highlighter-rouge">--files</code> option to upload a library and configure its relative path</li> </ul> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">--files</span> /path/to/gluten/cpp/build/velox/udf/examples/libmyudf.so
<span class="nt">--conf</span> spark.gluten.sql.columnar.backend.velox.udfLibraryPaths<span class="o">=</span>libmyudf.so
<span class="c"># Needed for Yarn client mode</span>
<span class="nt">--conf</span> spark.gluten.sql.columnar.backend.velox.driver.udfLibraryPaths<span class="o">=</span>file:///path/to/gluten/cpp/build/velox/udf/examples/libmyudf.so
</code></pre></div></div> <ul> <li>Use the <code class="language-plaintext highlighter-rouge">--archives</code> option to upload an archive and configure its relative path</li> </ul> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">--archives</span> /path/to/udf_archives.zip#udf_archives
<span class="nt">--conf</span> spark.gluten.sql.columnar.backend.velox.udfLibraryPaths<span class="o">=</span>udf_archives
<span class="c"># Needed for Yarn client mode</span>
<span class="nt">--conf</span> spark.gluten.sql.columnar.backend.velox.driver.udfLibraryPaths<span class="o">=</span>file:///path/to/udf_archives.zip
</code></pre></div></div> <ul> <li>Configure URI</li> </ul> <p>You can also specify the local or HDFS URIs to the UDF libraries or archives. Local URIs should exist on driver and every worker nodes.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">--conf</span> spark.gluten.sql.columnar.backend.velox.udfLibraryPaths<span class="o">=</span>file:///path/to/library_or_archive
</code></pre></div></div> <h2 id="try-the-example"> <a href="#try-the-example" class="anchor-heading" aria-labelledby="try-the-example"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Try the example </h2> <p>We provided Velox UDF examples in file <a href="../../cpp/velox/udf/examples/MyUDF.cc">MyUDF.cc</a> and UDAF examples in file <a href="../../cpp/velox/udf/examples/MyUDAF.cc">MyUDAF.cc</a>. You need to build the gluten project with <code class="language-plaintext highlighter-rouge">--build_example=ON</code> to get the example libraries.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./dev/buildbundle-veloxbe.sh <span class="nt">--build_examples</span><span class="o">=</span>ON
</code></pre></div></div> <p>Then, you can find the example libraries at /path/to/gluten/cpp/build/velox/udf/examples/</p> <p>Start spark-shell or spark-sql with below configuration</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Use the `--files` option to upload a library and configure its relative path</span>
<span class="nt">--files</span> /path/to/gluten/cpp/build/velox/udf/examples/libmyudf.so
<span class="nt">--conf</span> spark.gluten.sql.columnar.backend.velox.udfLibraryPaths<span class="o">=</span>libmyudf.so
</code></pre></div></div> <p>or</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Only configure URI</span>
<span class="nt">--conf</span> spark.gluten.sql.columnar.backend.velox.udfLibraryPaths<span class="o">=</span>file:///path/to/gluten/cpp/build/velox/udf/examples/libmyudf.so
</code></pre></div></div> <p>Run query. The functions <code class="language-plaintext highlighter-rouge">myudf1</code> and <code class="language-plaintext highlighter-rouge">myudf2</code> increment the input value by a constant of 5</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select myudf1(100L), myudf2(1)
</code></pre></div></div> <p>The output from spark-shell will be like</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+------------------+----------------+
|udfexpression(100)|udfexpression(1)|
+------------------+----------------+
|               105|               6|
+------------------+----------------+
</code></pre></div></div> <h2 id="configurations"> <a href="#configurations" class="anchor-heading" aria-labelledby="configurations"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Configurations </h2> <div class="table-wrapper"><table> <thead> <tr> <th>Parameters</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td>spark.gluten.sql.columnar.backend.velox.udfLibraryPaths</td> <td>Path to the udf/udaf libraries.</td> </tr> <tr> <td>spark.gluten.sql.columnar.backend.velox.driver.udfLibraryPaths</td> <td>Path to the udf/udaf libraries on driver node. Only applicable on yarn-client mode.</td> </tr> <tr> <td>spark.gluten.sql.columnar.backend.velox.udfAllowTypeConversion</td> <td>Whether to inject possible <code class="language-plaintext highlighter-rouge">cast</code> to convert mismatched data types from input to one registered signatures.</td> </tr> </tbody> </table></div> <h1 id="pandas-udfs-aka-vectorized-udfs"> <a href="#pandas-udfs-aka-vectorized-udfs" class="anchor-heading" aria-labelledby="pandas-udfs-aka-vectorized-udfs"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Pandas UDFs (a.k.a. Vectorized UDFs) </h1> <h2 id="introduction-1"> <a href="#introduction-1" class="anchor-heading" aria-labelledby="introduction-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Introduction </h2> <p>Pandas UDFs are user defined functions that are executed by Spark using Arrow to transfer data and Pandas to work with the data, which allows vectorized operations. A Pandas UDF is defined using the pandas_udf() as a decorator or to wrap the function, and no additional configuration is required. A Pandas UDF behaves as a regular PySpark function API in general. For more details, you can refer <a href="https://spark.apache.org/docs/latest/api/python/user_guide/sql/arrow_pandas.html">doc</a>.</p> <h2 id="using-pandas-udfs-in-gluten-with-velox-backend"> <a href="#using-pandas-udfs-in-gluten-with-velox-backend" class="anchor-heading" aria-labelledby="using-pandas-udfs-in-gluten-with-velox-backend"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Using Pandas UDFs in Gluten with Velox Backend </h2> <p>Similar as in vanilla Spark, user needs to set up pyspark/arrow dependencies properly first. You may can refer following steps:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip3 install pyspark==$SPARK_VERSION cython
pip3 install pandas pyarrow
</code></pre></div></div> <p>Gluten provides a config to control enable <code class="language-plaintext highlighter-rouge">ColumnarArrowEvalPython</code> or not, with <code class="language-plaintext highlighter-rouge">true</code> as defalt.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spark.gluten.sql.columnar.arrowUdf
</code></pre></div></div> <p>Then take following <code class="language-plaintext highlighter-rouge">PySpark</code> code for example:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>from pyspark.sql.functions import pandas_udf, PandasUDFType
import pyspark.sql.functions as F
import os
@pandas_udf('long')
def pandas_plus_one(v):
    return (v + 1)
df = spark.read.orc("path_to_file").select("quantity").withColumn("processed_quantity", pandas_plus_one("quantity")).select("quantity")
</code></pre></div></div> <p>The expected physical plan will be:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>== Physical Plan ==
VeloxColumnarToRowExec
+- ^(2) ProjectExecTransformer [pythonUDF0#45L AS processed_quantity#41L]
   +- ^(2) InputIteratorTransformer[quantity#2L, pythonUDF0#45L]
      +- ^(2) InputAdapter
         +- ^(2) ColumnarArrowEvalPython [pandas_plus_one(quantity#2L)#40L], [pythonUDF0#45L], 200
            +- ^(1) NativeFileScan orc [quantity#2L] Batched: true, DataFilters: [], Format: ORC, Location: InMemoryFileIndex(1 paths)[file:/***], PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;quantity:bigint&gt;
</code></pre></div></div> </main> <hr> <footer> <p><a href="#top" id="back-to-top">Back to top</a></p> <a href="https://incubator.apache.org/"><img src="/assets/images/apache-incubator.svg" style="width:300px"></a> <p class="text-small text-grey-dk-100 mb-0">Copyright © 2024 The Apache Software Foundation, Licensed under the Apache License, Version 2.0. Apache Gluten, Gluten, Apache, the Apache feather logo, and the Apache Gluten project logo are either registered trademarks or trademarks of the Apache Software Foundation in the United States and/or other countries.</p> <p class="text-small text-grey-dk-100 mb-0">Apache Gluten is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</p> <p class="text-small text-grey-dk-100 mb-0"><a href="https://privacy.apache.org/policies/privacy-policy-public.html">Privacy Policy</a></p> <p class="text-small text-grey-dk-100 mb-0">©Intel Corporation. Intel, the Intel logo, and other Intel marks are trademarks of Intel Corporation or its subsidiaries. All other marks mentioned may be trademarks or registered trademarks of their respective owners.</p> <div class="d-flex mt-2"> </div> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
